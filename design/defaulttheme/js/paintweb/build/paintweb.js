var pwlib={};pwlib.fileCache={};pwlib.tools={};pwlib.extensions={};pwlib.extend=function(){var a,d,b,c;if(typeof arguments[0]==="boolean"){force=arguments[0];dest=arguments[1];d=arguments[2]}else{force=false;dest=arguments[0];d=arguments[1]}if(typeof d==="undefined"){d=dest;dest=this}if(typeof dest==="undefined"){return}for(a in d){b=d[a];c=dest[a];if(force||typeof c==="undefined"){dest[a]=b}}};pwlib.strf=function(d,c){if(!d){return d}var b,a;for(a in c){b=new RegExp("{"+a+"}","g");d=d.replace(b,c[a])}return d};pwlib.jsonParse=function(a){a=a.replace(/\s*\/\*(\s|.)+?\*\//g,"").replace(/^\s*\/\/.*$/gm,"");return JSON.parse(a)};pwlib.xhrLoad=function(a,b,g,c,e){if(typeof a!=="string"){throw new TypeError("The first argument must be a string!")}if(!g){g="GET"}if(!e){e={}}if(!c){c=null}var d=new XMLHttpRequest();d.onreadystatechange=function(){b(d)};d.open(g,a);for(var f in e){d.setRequestHeader(f,e[f])}d.send(c);return d};pwlib.isSameHost=function(b,d){if(!b||!d){return false}var e=b.indexOf(":"),c=b.substr(0,e+1).toLowerCase();if(c==="data:"){return true}if(c!=="http:"&&c!=="https:"){return false}var a=b.replace(/^https?:\/\//i,"");e=a.indexOf("/");if(e>-1){a=a.substr(0,e)}a=a.replace(/:80$/,"");d=d.replace(/:80$/,"");if(!a||!d||a!==d){return false}return true};pwlib.appEvent=function(b,a){if(typeof b!=="string"){throw new TypeError("The first argument must be a string")}else{if(typeof a==="undefined"){a=false}else{if(typeof a!=="boolean"){throw new TypeError("The second argument must be a boolean")}}}this.target=null;this.cancelable=a;this.defaultPrevented=false;this.type=b;this.preventDefault=function(){if(a){this.defaultPrevented=true}};this.stopPropagation=function(){this.propagationStopped_=true};this.toString=function(){return"[pwlib.appEvent."+this.type+"]"}};pwlib.appEvent.appInit=function(b,a){if(typeof b!=="number"){throw new TypeError("The first argument must be a number.")}this.INIT_NOT_STARTED=0;this.INIT_STARTED=1;this.INIT_DONE=2;this.INIT_ERROR=-1;this.state=b;this.errorMessage=a||null;pwlib.appEvent.call(this,"appInit")};pwlib.appEvent.appDestroy=function(){pwlib.appEvent.call(this,"appDestroy")};pwlib.appEvent.guiShow=function(){pwlib.appEvent.call(this,"guiShow")};pwlib.appEvent.guiHide=function(){pwlib.appEvent.call(this,"guiHide")};pwlib.appEvent.toolPreactivate=function(b,a){if(typeof b!=="string"){throw new TypeError("The first argument must be a string.")}else{if(a!==null&&typeof a!=="string"){throw new TypeError("The second argument must be a string or null.")}}this.id=b;this.prevId=a;pwlib.appEvent.call(this,"toolPreactivate",true)};pwlib.appEvent.toolActivate=function(b,a){if(typeof b!=="string"){throw new TypeError("The first argument must be a string.")}else{if(a!==null&&typeof a!=="string"){throw new TypeError("The second argument must be a string or null.")}}this.id=b;this.prevId=a;pwlib.appEvent.call(this,"toolActivate")};pwlib.appEvent.toolRegister=function(a){if(typeof a!=="string"){throw new TypeError("The first argument must be a string.")}this.id=a;pwlib.appEvent.call(this,"toolRegister")};pwlib.appEvent.toolUnregister=function(a){if(typeof a!=="string"){throw new TypeError("The first argument must be a string.")}this.id=a;pwlib.appEvent.call(this,"toolUnregister")};pwlib.appEvent.extensionRegister=function(a){if(typeof a!=="string"){throw new TypeError("The first argument must be a string.")}this.id=a;pwlib.appEvent.call(this,"extensionRegister")};pwlib.appEvent.extensionUnregister=function(a){if(typeof a!=="string"){throw new TypeError("The first argument must be a string.")}this.id=a;pwlib.appEvent.call(this,"extensionUnregister")};pwlib.appEvent.commandRegister=function(a){if(typeof a!=="string"){throw new TypeError("The first argument must be a string.")}this.id=a;pwlib.appEvent.call(this,"commandRegister")};pwlib.appEvent.commandUnregister=function(a){if(typeof a!=="string"){throw new TypeError("The first argument must be a string.")}this.id=a;pwlib.appEvent.call(this,"commandUnregister")};pwlib.appEvent.imageSave=function(c,b,a){this.dataURL=c;this.width=b;this.height=a;pwlib.appEvent.call(this,"imageSave",true)};pwlib.appEvent.imageSaveResult=function(c,a,b){this.successful=c;this.url=a;this.urlNew=b;pwlib.appEvent.call(this,"imageSaveResult")};pwlib.appEvent.historyUpdate=function(c,a,b){if(typeof c!=="number"||typeof a!=="number"||typeof b!=="number"){throw new TypeError("All arguments must be numbers.")}this.currentPos=c;this.previousPos=a;this.states=b;pwlib.appEvent.call(this,"historyUpdate")};pwlib.appEvent.imageSizeChange=function(b,a){if(typeof b!=="number"||typeof a!=="number"){throw new TypeError("Both arguments must be numbers.")}this.width=b;this.height=a;pwlib.appEvent.call(this,"imageSizeChange")};pwlib.appEvent.canvasSizeChange=function(b,a,c){if(typeof b!=="number"||typeof a!=="number"||typeof c!=="number"){throw new TypeError("All the arguments must be numbers.")}this.width=b;this.height=a;this.scale=c;pwlib.appEvent.call(this,"canvasSizeChange")};pwlib.appEvent.viewportSizeChange=function(b,a){this.width=b;this.height=a;pwlib.appEvent.call(this,"viewportSizeChange")};pwlib.appEvent.imageZoom=function(a){if(typeof a!=="number"){throw new TypeError("The first argument must be a number.")}this.zoom=a;pwlib.appEvent.call(this,"imageZoom",true)};pwlib.appEvent.imageCrop=function(b,d,c,a){if(typeof b!=="number"||typeof d!=="number"||typeof c!=="number"||typeof a!=="number"){throw new TypeError("All arguments must be numbers.")}this.x=b;this.y=d;this.width=c;this.height=a;pwlib.appEvent.call(this,"imageCrop",true)};pwlib.appEvent.configChange=function(d,a,b,e,c){if(typeof b!=="string"){throw new TypeError("The third argument must be a string.")}else{if(typeof e!=="string"){throw new TypeError("The fourth argument must be a string.")}else{if(typeof c!=="object"){throw new TypeError("The fifth argument must be an object.")}}}this.value=d;this.previousValue=a;this.config=b;this.group=e;this.groupRef=c;pwlib.appEvent.call(this,"configChange")};pwlib.appEvent.shadowAllow=function(a){if(typeof a!=="boolean"){throw new TypeError("The first argument must be a boolean.")}this.allowed=a;pwlib.appEvent.call(this,"shadowAllow")};pwlib.appEvent.clipboardUpdate=function(a){this.data=a;pwlib.appEvent.call(this,"clipboardUpdate")};pwlib.appEvents=function(c){var b={};var a=1;this.add=function(e,d){if(typeof e!=="string"){throw new TypeError("The first argument must be a string.")}else{if(typeof d!=="function"){throw new TypeError("The second argument must be a function.")}}var f=a++;if(!(e in b)){b[e]={}}b[e][f]=d;return f};this.remove=function(d,e){if(typeof d!=="string"){throw new TypeError("The first argument must be a string.")}if(!(d in b)||!(e in b[d])){return}delete b[d][e]};this.dispatch=function(e){if(typeof e!=="object"){throw new TypeError("The second argument must be an object.")}else{if(typeof e.type!=="string"){throw new TypeError("The second argument must be an application event object.")}}if(!(e.type in b)){return false}e.target=c;var f,d=b[e.type];for(f in d){d[f].call(c,e);if(e.propagationStopped_){break}}return e.defaultPrevented}};pwlib.browser={};(function(){var a="";if(window.navigator&&window.navigator.userAgent){a=window.navigator.userAgent.toLowerCase()}pwlib.browser.opera=window.opera||/\bopera\b/.test(a);pwlib.browser.webkit=!pwlib.browser.opera&&/\b(applewebkit|webkit)\b/.test(a);pwlib.browser.firefox=/\bfirefox\b/.test(a)&&!pwlib.browser.opera;pwlib.browser.gecko=/\bgecko\b/.test(a)&&!pwlib.browser.opera&&!pwlib.browser.webkit;pwlib.browser.msie=/\bmsie\b/.test(a)&&!pwlib.browser.opera;pwlib.browser.presto=/\bpresto\b/.test(a)||pwlib.browser.opera;pwlib.browser.os=(a.match(/\b(windows|linux)\b/)||[])[1];pwlib.browser.olpcxo=/\bolpc\b/.test(a)&&/\bxo\b/.test(a);delete a})();pwlib.dom={};pwlib.dom.keyNames={Help:6,Backspace:8,Tab:9,Clear:12,Enter:13,Shift:16,Control:17,Alt:18,Pause:19,CapsLock:20,Cancel:24,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,PrintScreen:44,Insert:45,Delete:46,Win:91,ContextMenu:93,"*":106,"+":107,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NumLock:144,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222};pwlib.dom.keyCodes={3:"Enter",6:"Help",8:"Backspace",9:"Tab",10:"Enter",12:"Clear",13:"Enter",14:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",24:"Cancel",27:"Escape",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",127:"Delete",144:"NumLock",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};if(pwlib.browser.gecko){pwlib.dom.keyCodes[3]="Cancel"}pwlib.dom.keyCodes_fixes={42:pwlib.dom.keyNames["*"],47:pwlib.dom.keyNames["/"],59:pwlib.dom.keyNames[";"],61:pwlib.dom.keyNames["="],96:48,97:49,98:50,99:51,100:52,101:53,102:54,103:55,104:56,105:57,109:pwlib.dom.keyNames["-"],110:pwlib.dom.keyNames["."],111:pwlib.dom.keyNames["/"]};pwlib.dom.keyCodes_Safari2={63232:pwlib.dom.keyNames.Up,63233:pwlib.dom.keyNames.Down,63234:pwlib.dom.keyNames.Left,63235:pwlib.dom.keyNames.Right,63236:pwlib.dom.keyNames.F1,63237:pwlib.dom.keyNames.F2,63238:pwlib.dom.keyNames.F3,63239:pwlib.dom.keyNames.F4,63240:pwlib.dom.keyNames.F5,63241:pwlib.dom.keyNames.F6,63242:pwlib.dom.keyNames.F7,63243:pwlib.dom.keyNames.F8,63244:pwlib.dom.keyNames.F9,63245:pwlib.dom.keyNames.F10,63246:pwlib.dom.keyNames.F11,63247:pwlib.dom.keyNames.F12,63248:pwlib.dom.keyNames.PrintScreen,63272:pwlib.dom.keyNames.Delete,63273:pwlib.dom.keyNames.Home,63275:pwlib.dom.keyNames.End,63276:pwlib.dom.keyNames.PageUp,63277:pwlib.dom.keyNames.PageDown,63289:pwlib.dom.keyNames.NumLock,63302:pwlib.dom.keyNames.Insert};pwlib.dom.KeyboardEventListener=function(o,n){var h=null;var l=null;var g=null;var i=null;var f=false;if(!n){throw new TypeError("The first argument must be of type an object.")}if(!n.keydown&&!n.keypress&&!n.keyup){throw new TypeError("The provided handlers object has no keyboard eventhandler.")}if(n.keydown&&typeof n.keydown!=="function"){throw new TypeError("The keydown event handler is not a function!")}if(n.keypress&&typeof n.keypress!=="function"){throw new TypeError("The keypress event handler is not a function!")}if(n.keyup&&typeof n.keyup!=="function"){throw new TypeError("The keyup event handler is not a function!")}this.attach=function(){h=null;l=null;g=null;i=null;f=false;o.addEventListener("keydown",e,false);o.addEventListener("keypress",c,false);o.addEventListener("keyup",b,false)};this.detach=function(){o.removeEventListener("keydown",e,false);o.removeEventListener("keypress",c,false);o.removeEventListener("keyup",b,false);h=null;l=null;g=null;i=null;f=false};function j(q,r){if(!n[q]){return}var p=n[q];if(q===r.type){p.call(o,r)}else{var s={};pwlib.extend(s,r);s.type=q;s.preventDefault=function(){r.preventDefault()};p.call(o,s)}}function e(q){var p=l;g=null;i=null;k(q);q.keyCode_=h;q.key_=l;q.repeat_=l&&p===l?true:false;f=q.repeat_;if(!f){j("keydown",q)}if(!a(l)&&!d(q)){q.type_="keydown";c(q)}}function c(p){if(!h){k(p);f=false}p.keyCode_=h;p.key_=l;m(p);p.charCode_=g;p.char_=i;p.repeat_=f;if(!f){f=true}if(!a(l)){j("keypress",p)}}function b(p){k(p);p.keyCode_=h;p.key_=l;p.charCode_=g;p.char_=i;j("keyup",p);h=null;l=null;g=null;i=null;f=false}function a(p){switch(p){case"Shift":case"Control":case"Alt":case"Meta":case"Win":return true;default:return false}}function d(p){if((l==="Up"||l==="Down")&&pwlib.browser.gecko&&p.target&&p.target.tagName.toLowerCase()==="input"){return false}if(!pwlib.browser.msie&&!pwlib.browser.webkit){return true}if(l&&l!=="Space"&&l!=="Enter"&&l!=="Escape"&&l.length!==1){return false}if(pwlib.browser.webkit&&l==="Escape"){return false}if(pwlib.browser.msie&&!p.shiftKey&&(p.ctrlKey||p.altKey)){return false}return true}function k(q){if(q.type==="keyup"&&!q.keyCode&&!q.which&&(!q.keyIdentifier||q.keyIdentifier==="Unidentified"||q.keyIdentifier==="U+0000")){return}h=null;l=null;if(q.keyCode||q.which){h=q.keyCode||q.which;if(pwlib.browser.webkit){if(h==25&&this.shiftKey){h=pwlib.dom.keyNames.Tab}else{if(h>=63232&&h in pwlib.dom.keyCodes_Safari2){h=pwlib.dom.keyCodes_Safari2[h]}}}if(h in pwlib.dom.keyCodes_fixes){h=pwlib.dom.keyCodes_fixes[h]}l=pwlib.dom.keyCodes[h]||String.fromCharCode(h);return}var p=null,r=null,s=q.keyIdentifier;if(!s||s==="Unidentified"||s==="U+0000"){return}if(s.substr(0,2)==="U+"){r=parseInt(s.substr(2),16)}else{if(s.length===1){r=s.charCodeAt(0);p=s}else{h=pwlib.dom.keyNames[s]||null;l=s;return}}if(r in pwlib.dom.keyCodes&&(r<=32||r==127||r==144)){l=pwlib.dom.keyCodes[r]}else{if(!p){p=String.fromCharCode(r)}l=p.toUpperCase();if(p!==l){r=l.charCodeAt(0)}}if(l==="Delete"||l.length===1&&l in pwlib.dom.keyNames){r=pwlib.dom.keyNames[l]}h=r}function m(r){g=null;i=null;if(r.charCode){g=r.charCode;i=String.fromCharCode(r.charCode);return}if(r.keyCode||r.which){var t=r.keyCode||r.which;var s=false;switch(t){case pwlib.dom.keyNames.Tab:case pwlib.dom.keyNames.Enter:case pwlib.dom.keyNames.Space:s=true}if(!s&&l&&l.length!==1){return}if(r.type_==="keydown"){var q=pwlib.dom.keyCodes[t];if(q&&q.length===1){g=q.charCodeAt(0);i=q}}else{if(t>=32||s){g=t;i=String.fromCharCode(t)}}if(g){return}}var v=null,p=null,u=r.keyIdentifier;if(u&&u!=="Unidentified"&&u!=="U+0000"&&(u.substr(0,2)==="U+"||u.length===1)){if(u.length===1){p=u.charCodeAt(0);v=u}else{p=parseInt(u.substr(2),16)}if(p==pwlib.dom.keyNames.Tab||p==pwlib.dom.keyNames.Enter||p>=32&&p!=127&&p!=pwlib.dom.keyNames.NumLock){g=p;i=v||String.fromCharCode(p);return}}if(l&&l.length===1){g=l.charCodeAt(0);i=l}}this.attach()};pwlib.tools.bcurve=function(f){var k=this,m=f.win.clearInterval,d=f.config,b=f.buffer.context,c=f.gui,g=f.image,i=f.mouse,h=f.win.setInterval,e=f.toolSnapXY;var l=[];var a=null;var j=false;var n=false;this.deactivate=function(){if(a){m(a);a=null}if(l.length>0){b.clearRect(0,0,g.width,g.height)}n=false;l=[];return true};this.mousedown=function(o){if(l.length===0){c.statusShow("bcurveSnapping");l.push([i.x,i.y])}if(!a){a=h(k.draw,d.toolDrawDelay)}j=o.shiftKey;n=false;return true};this.mousemove=function(o){j=o.shiftKey;n=true};this.draw=function(){if(!n){return}var u=l.length;if(i.buttonDown){if(j&&u===1){e(l[0][0],l[0][1])}l.push([i.x,i.y]);u++}var t=l[0],r=l[1],q=l[2],p=l[3]||l[2];if(i.buttonDown){l.pop()}b.clearRect(0,0,g.width,g.height);if(!u){n=false;return}if(u===2){b.beginPath();b.moveTo(t[0],t[1]+2);b.lineTo(r[0],r[1]+2);if(d.shapeType==="fill"){var o=b.lineWidth,s=b.strokeStyle;b.lineWidth=1;b.strokeStyle=b.fillStyle}b.stroke();b.closePath();if(d.shapeType==="fill"){b.lineWidth=o;b.strokeStyle=s}n=false;return}b.beginPath();b.moveTo(t[0],t[1]);b.bezierCurveTo(q[0],q[1],p[0],p[1],r[0],r[1]);if(d.shapeType!=="stroke"){b.fill()}if(d.shapeType!=="fill"){b.stroke()}b.closePath();n=false};this.mouseup=function(o){var p=l.length;if(p===1&&i.x===l[0][0]&&i.y===l[0][1]){i.buttonDown=true;return true}if(a){m(a);a=null}if(p===1&&o.shiftKey){e(l[0][0],l[0][1])}if(p<4){l.push([i.x,i.y]);n=true;p++}j=o.shiftKey;k.draw();if(p===2||p===3){c.statusShow("bcurveControlPoint"+(p-1))}else{if(p===4){c.statusShow("bcurveActive");f.layerUpdate();l=[]}}return true};this.keydown=function(o){if(!l.length||o.kid_!=="Escape"){return false}if(a){m(a);a=null}b.clearRect(0,0,g.width,g.height);l=[];n=false;i.buttonDown=false;c.statusShow("bcurveActive");return true}};pwlib.tools.cbucket=function(d){var l=this,a=d.config,i=d.layer.context,f=d.buffer.context,e=d.image.width,m=d.image.height,j=d.mouse;var c=10000;var p=[];var b,h;this.preActivate=function(){if(!i.getImageData||!i.putImageData){alert(d.lang.errorCbucketUnsupported);return false}else{return true}};this.activate=function(){d.shadowDisallow()};this.deactivate=function(){d.shadowAllow()};this.click=function(r){if(r.type==="contextmenu"||r.button===2||r.shiftKey){var q=f.fillStyle;f.fillStyle=f.strokeStyle;f.fillRect(0,0,1,1);f.fillStyle=q}else{f.fillRect(0,0,1,1)}b=f.getImageData(0,0,1,1);b=[b.data[0],b.data[1],b.data[2],b.data[3]];f.clearRect(0,0,1,1);var s=i.getImageData(j.x,j.y,1,1).data;s=s[0]+";"+s[1]+";"+s[2]+";"+s[3];if(s===b.join(";")){return false}o(j.x,j.y,s);d.historyAdd();return true};this.contextmenu=this.click;var o=function(w,v,z){var r,s,q,A,u,t;n(v,w,w,1);n(v+1,w,w,-1);while(p.length>0){u=p.pop();A=u[3];v=u[0]+A;s=u[1];q=u[2];h=null;t=i.getImageData(0,v,e,1);h=t.data;for(w=s;w>=0&&k(w)===z;w--){g(w)}if(w>=s){for(w++;w<=q&&k(w)!==z;w++){}r=w;if(w>q){i.putImageData(t,0,v);continue}}else{r=w+1;if(r<s){n(v,r,s-1,-A)}w=s+1}do{for(;w<e&&k(w)===z;w++){g(w)}n(v,r,w-1,A);if(w>(q+1)){n(v,q+1,w-1,-A)}for(w++;w<=q&&k(w)!==z;w++){}r=w}while(w<=q);i.putImageData(t,0,v)}h=null;t=null};var n=function(t,s,r,q){if(p.length<c&&(t+q)>=0&&(t+q)<m){p.push([t,s,r,q])}};var k=function(q){var s=4*q;return h[s]+";"+h[s+1]+";"+h[s+2]+";"+h[s+3]};var g=function(q){var s=4*q;h[s]=b[0];h[s+1]=b[1];h[s+2]=b[2];h[s+3]=b[3]}};pwlib.tools.cpicker=function(g){var m=this,l=g.extensions.colormixer,b=g.layer.context,c=g.gui,e=g.lang,j=Math.round,k=g.mouse;var i=null;var h=null;var a=null;var o=false;var n=false;this.preActivate=function(){if(!b.getImageData){alert(e.errorCpickerUnsupported);return false}if(g.tool&&g.tool._id){i=g.tool._id}return true};this.activate=function(){if(l&&l.targetInput){h=c.colorInputs[l.targetInput.id]}if(h){c.statusShow("cpicker_"+h.id)}else{c.statusShow("cpickerNormal")}g.shadowDisallow()};this.deactivate=function(){if(!n&&h&&a){f(null,true)}g.shadowAllow()};this.mousedown=function(p){if(l&&l.targetInput){h=c.colorInputs[l.targetInput.id]}if(h){o=true;c.statusShow("cpicker_"+h.id)}else{o=false;c.statusShow("cpickerNormal");if(p.button===2||p.shiftKey){h=c.colorInputs.strokeStyle}else{h=c.colorInputs.fillStyle}}d();m.mousemove=f;f(p);return true};function f(s,r){if(!h){return}var t=r?a:b.getImageData(k.x,k.y,1,1),q={red:t.data[0]/255,green:t.data[1]/255,blue:t.data[2]/255,alpha:(t.data[3]/255).toFixed(3)};if(o){l.color.red=q.red;l.color.green=q.green;l.color.blue=q.blue;l.color.alpha=q.alpha;l.update_color("rgb")}else{h.updateColor(q)}}this.mouseup=function(s){if(!h){return false}delete m.mousemove;f(s);n=true;if(!o){var p=h.color,v=h.configProperty,t=h.configGroup,r=h.configGroupRef,u=r[v],q="rgba("+j(p.red*255)+","+j(p.green*255)+","+j(p.blue*255)+","+p.alpha+")";if(u!==q){r[v]=q;g.events.dispatch(new pwlib.appEvent.configChange(q,u,v,t,r))}}if(i){g.toolActivate(i,s)}return true};this.keydown=function(p){if(!i||p.kid_!=="Escape"){return false}k.buttonDown=false;g.toolActivate(i,p);return true};this.contextmenu=function(){return true};function d(){var p=o?l.color:h.color;a={width:1,height:1,data:[j(p.red*255),j(p.green*255),j(p.blue*255),p.alpha*255]}}};pwlib.tools.ellipse=function(g){var l=this,p=g.win.clearInterval,f=g.config,b=g.buffer.context,c=g.gui,h=g.image,e=Math.max,o=Math.min,j=g.mouse,i=g.win.setInterval;var a=null;var k=false;var q=false;var m=4*((Math.SQRT2-1)/3);var d=0;var n=0;this.deactivate=function(){if(a){p(a);a=null}if(j.buttonDown){b.clearRect(0,0,h.width,h.height)}q=false;return true};this.mousedown=function(r){d=j.x;n=j.y;if(!a){a=i(l.draw,f.toolDrawDelay)}k=r.shiftKey;q=false;c.statusShow("ellipseMousedown");return true};this.mousemove=function(r){k=r.shiftKey;q=true};this.draw=function(){if(!q){return}b.clearRect(0,0,h.width,h.height);var A=o(j.x,d),z=e(j.x,d),x=o(j.y,n),v=e(j.y,n);var B=z-A,y=v-x;if(!B||!y){q=false;return}if(k){if(B>y){v=x+B;if(x==j.y){x-=B-y;v-=B-y}y=B}else{z=A+y;if(A==j.x){A-=y-B;z-=y-B}B=y}}var s=B/2,r=y/2;var u=A+s,t=x+r;s*=m;r*=m;b.beginPath();b.moveTo(u,x);b.bezierCurveTo(u+s,x,z,t-r,z,t);b.bezierCurveTo(z,t+r,u+s,v,u,v);b.bezierCurveTo(u-s,v,A,t+r,A,t);b.bezierCurveTo(A,t-r,u-s,x,u,x);if(f.shapeType!="stroke"){b.fill()}if(f.shapeType!="fill"){b.stroke()}b.closePath();q=false};this.mouseup=function(r){if(j.x==d&&j.y==n){j.buttonDown=true;return true}if(a){p(a);a=null}k=r.shiftKey;l.draw();g.layerUpdate();c.statusShow("ellipseActive");return true};this.keydown=function(r){if(!j.buttonDown||r.kid_!="Escape"){return false}if(a){p(a);a=null}b.clearRect(0,0,h.width,h.height);j.buttonDown=false;q=false;c.statusShow("ellipseActive");return true}};pwlib.tools.eraser=function(f){var k=this,b=f.buffer.context,o=f.win.clearInterval,e=f.config,j=f.history.pos,g=f.image,l=f.layer.context,i=f.mouse,h=f.win.setInterval;var c=null;var n=[];var d=0;var m=0;var p=null,a=null;this.deactivate=function(){if(c){o(c);c=null}if(i.buttonDown){if(p){l.globalCompositeOperation=p}if(a){l.lineWidth=a}f.historyGoto(j.pos)}n=[];f.shadowAllow()};this.activate=function(){f.shadowDisallow()};this.mousedown=function(){p=l.globalCompositeOperation;a=l.lineWidth;l.globalCompositeOperation="destination-out";l.lineWidth=b.lineWidth;d=i.x;m=i.y;n=[];if(!c){c=h(k.draw,e.toolDrawDelay)}return true};this.mousemove=function(){if(i.buttonDown){n.push(i.x,i.y)}};this.draw=function(){var q=0,r=n.length;if(!r){return}l.beginPath();l.moveTo(d,m);while(q<r){d=n[q++];m=n[q++];l.lineTo(d,m)}l.stroke();l.closePath();n=[]};this.mouseup=function(){if(i.x==d&&i.y==m){n.push(d+1,m+1)}if(c){o(c);c=null}k.draw();l.globalCompositeOperation=p;l.lineWidth=a;f.historyAdd();return true};this.keydown=function(q){if(!i.buttonDown||q.kid_!="Escape"){return false}if(c){o(c);c=null}l.globalCompositeOperation=p;l.lineWidth=a;i.buttonDown=false;n=[];f.historyGoto(j.pos);return true}};pwlib.tools.hand=function(f){var j=this,a=f.buffer.canvas,n=a.style,e=f.config;clearInterval=f.win.clearInterval,image=f.image,MathRound=Math.round,mouse=f.mouse,viewport=f.gui.elems.viewport,vheight=0,vwidth=0,setInterval=f.win.setInterval;var c=null;var l=false;this.prevTool=null;var d=0,m=0,b=0,k=0,h=0,i=0;this.preActivate=function(){if(!viewport){return false}j.prevTool=f.tool._id;var r=f.win.getComputedStyle(viewport,null),s=parseInt(n.width),q=parseInt(n.height);vwidth=parseInt(r.width),vheight=parseInt(r.height);if(vheight<q||vwidth<s){return true}else{return false}};this.activate=function(){n.cursor="move";f.shadowDisallow()};this.deactivate=function(q){if(c){clearInterval(c);c=null;f.doc.removeEventListener("mousemove",o,false);f.doc.removeEventListener("mouseup",p,false)}n.cursor="";f.shadowAllow()};this.mousedown=function(q){d=q.clientX;m=q.clientY;h=viewport.scrollLeft;i=viewport.scrollTop;l=false;f.doc.addEventListener("mousemove",o,false);f.doc.addEventListener("mouseup",p,false);if(!c){c=setInterval(g,e.toolDrawDelay)}return true};function o(q){b=q.clientX;k=q.clientY;l=true}function g(){if(l){viewport.scrollTop=i-k+m;viewport.scrollLeft=h-b+d;l=false}}function p(q){if(c){clearInterval(c);c=null}o(q);g();f.doc.removeEventListener("mousemove",o,false);f.doc.removeEventListener("mouseup",p,false);mouse.buttonDown=false}this.keydown=function(q){if(!j.prevTool||q.kid_!="Escape"){return false}f.toolActivate(j.prevTool,q);return true}};pwlib.tools.insertimg=function(h){var g=this,r=h.image,j=h.win.clearInterval,v=h.config,e=h.buffer.context,m=h.gui,w=h.lang,p=Math.abs,u=Math.min,t=Math.round,k=h.mouse,a=h.win.setInterval;var d=h.tool?h.tool._id:null;var i=null;var n=false;var o=false;var s=0;var f=0;var b=false;var c=1;var q=null;if(!this.url){this.url="http://"}this.preActivate=function(){if(!m.elems.viewport){return false}g.url=prompt(w.promptInsertimg,g.url);if(!g.url||g.url.toLowerCase()==="http://"){return false}pwlib.extend(true,g.constructor.prototype,{url:g.url});if(!pwlib.isSameHost(g.url,h.win.location.host)){alert(w.errorInsertimgHost);return false}return true};this.activate=function(){q=new Image();q.addEventListener("load",l,false);q.src=g.url;return true};this.deactivate=function(){if(q){q=null}if(i){j(i);i=null}o=false;e.clearRect(0,0,r.width,r.height);return true};function l(){if(b){return}var z=t(m.elems.viewport.scrollLeft/r.canvasScale),B=t(m.elems.viewport.scrollTop/r.canvasScale);e.clearRect(0,0,r.width,r.height);try{e.drawImage(q,z,B)}catch(A){alert(w.errorInsertimg);return}b=true;o=false;if(!i){i=a(g.draw,v.toolDrawDelay)}m.statusShow("insertimgLoaded")}this.mousedown=function(x){if(!b){alert(w.errorInsertimgNotLoaded);return false}s=k.x;f=k.y;c=q.width/q.height;n=x.shiftKey;m.statusShow("insertimgResize");if(x.stopPropagation){x.stopPropagation()}};this.mousemove=function(x){n=x.shiftKey;o=true};this.draw=function(){if(!b||!o){return}e.clearRect(0,0,r.width,r.height);if(k.buttonDown){var A=p(k.x-s),B=p(k.y-f),z=u(k.x,s),C=u(k.y,f);if(!A||!B){o=false;return}if(n){if(A>B){if(C==k.y){C-=A-B}B=t(A/c)}else{if(z==k.x){z-=B-A}A=t(B*c)}}e.drawImage(q,z,C,A,B)}else{e.drawImage(q,k.x,k.y)}o=false};this.mouseup=function(x){if(!b){return false}if(i){j(i);i=null}h.layerUpdate();if(d){h.toolActivate(d,x)}if(x.stopPropagation){x.stopPropagation()}};this.keydown=function(x){if(!d||x.kid_!="Escape"){return false}if(i){j(i);i=null}k.buttonDown=false;h.toolActivate(d,x);return true}};pwlib.tools.line=function(g){var l=this,n=g.win.clearInterval,e=g.config,b=g.buffer.context,c=g.gui,h=g.image,j=g.mouse,i=g.win.setInterval,f=g.toolSnapXY;var a=null;var k=false;var o=false;var d=0;var m=0;this.deactivate=function(){if(a){n(a);a=null}if(j.buttonDown){b.clearRect(0,0,h.width,h.height)}o=false;return true};this.mousedown=function(p){d=j.x;m=j.y;if(!a){a=i(l.draw,e.toolDrawDelay)}k=p.shiftKey;o=false;c.statusShow("lineMousedown");return true};this.mousemove=function(p){k=p.shiftKey;o=true};this.draw=function(){if(!o){return}b.clearRect(0,0,h.width,h.height);if(k){f(d,m)}b.beginPath();b.moveTo(d,m);b.lineTo(j.x,j.y);b.stroke();b.closePath();o=false};this.mouseup=function(p){if(j.x==d&&j.y==m){j.buttonDown=true;return true}if(a){n(a);a=null}k=p.shiftKey;l.draw();c.statusShow("lineActive");g.layerUpdate();return true};this.keydown=function(p){if(!j.buttonDown||p.kid_!="Escape"){return false}if(a){n(a);a=null}b.clearRect(0,0,h.width,h.height);j.buttonDown=false;o=false;c.statusShow("lineActive");return true}};pwlib.tools.pencil=function(d){var h=this,k=d.win.clearInterval,b=d.buffer.context,e=d.image,g=d.mouse,f=d.win.setInterval;var a=null;var j=[];var c=0;var i=0;this.deactivate=function(){if(a){k(a);a=null}if(g.buttonDown){b.clearRect(0,0,e.width,e.height)}j=[]};this.mousedown=function(){c=g.x;i=g.y;j=[];if(!a){a=f(h.draw,d.config.toolDrawDelay)}return true};this.mousemove=function(){if(g.buttonDown){j.push(g.x,g.y)}};this.draw=function(){var l=0,m=j.length;if(!m){return}b.beginPath();b.moveTo(c,i);while(l<m){c=j[l++];i=j[l++];b.lineTo(c,i)}b.stroke();b.closePath();j=[]};this.mouseup=function(){if(g.x==c&&g.y==i){j.push(c+1,i+1)}if(a){k(a);a=null}h.draw();d.layerUpdate();return true};this.keydown=function(l){if(!g.buttonDown||l.kid_!="Escape"){return false}if(a){k(a);a=null}b.clearRect(0,0,e.width,e.height);g.buttonDown=false;j=[];return true}};pwlib.tools.polygon=function(f){var l=this,n=f.win.clearInterval,d=f.config,b=f.buffer.context,c=f.gui,g=f.image,h=Math.abs,j=f.mouse,i=f.win.setInterval,e=f.toolSnapXY;var m=[];var a=null;var k=false;var o=false;this.deactivate=function(){if(a){n(a);a=null}if(m.length){b.clearRect(0,0,g.width,g.height)}o=false;m=[];return true};this.mousedown=function(p){if(m.length==0){m.push([j.x,j.y])}if(!a){a=i(l.draw,d.toolDrawDelay)}k=p.shiftKey;o=false;c.statusShow("polygonMousedown");return true};this.mousemove=function(p){k=p.shiftKey;o=true};this.draw=function(q){if(!o){return}var r=m.length;if(!r||(r==1&&!j.buttonDown)){o=false;return}if(j.buttonDown&&k){e(m[r-1][0],m[r-1][1])}b.clearRect(0,0,g.width,g.height);b.beginPath();b.moveTo(m[0][0],m[0][1]);for(var p=0;p<r;p++){b.lineTo(m[p][0],m[p][1])}if(j.buttonDown){b.lineTo(j.x,j.y)}if(d.shapeType!="stroke"){b.fill()}if(d.shapeType!="fill"||r==1){b.stroke()}b.closePath();o=false};this.mouseup=function(p){var u=m.length;if(u==1&&j.x==m[u-1][0]&&j.y==m[u-1][1]){j.buttonDown=true;return true}if(a){n(a);a=null}k=p.shiftKey;o=true;if(p.shiftKey){e(m[u-1][0],m[u-1][1])}var r=h(j.x-m[0][0]),t=h(j.y-m[0][1]),q=h(j.x-m[u-1][0]),s=h(j.y-m[u-1][1]);if((r<5&&t<5)||(q<5&&s<5)){m.push(m[0]);l.draw();m=[];c.statusShow("polygonActive");f.layerUpdate();return true}if(u>3){c.statusShow("polygonEnd")}else{c.statusShow("polygonAddPoint")}m.push([j.x,j.y]);l.draw();return true};this.keydown=function(p){var q=m.length;if(!q||(p.kid_!="Escape"&&p.kid_!="Enter")){return false}if(a){n(a);a=null}j.buttonDown=false;if(p.kid_=="Escape"){b.clearRect(0,0,g.width,g.height);o=false}else{if(p.kid_=="Enter"){m.push([j.x,j.y]);m.push(m[0]);o=true;l.draw();f.layerUpdate()}}m=[];c.statusShow("polygonActive");return true}};pwlib.tools.rectangle=function(f){var l=this,o=f.win.clearInterval,e=f.config,b=f.buffer.context,c=f.gui,g=f.image,h=Math.abs,n=Math.min,j=f.mouse,i=f.win.setInterval;var a=null;var k=false;var p=false;var d=0;var m=0;this.deactivate=function(){if(a){o(a);a=null}if(j.buttonDown){b.clearRect(0,0,g.width,g.height)}p=false};this.mousedown=function(q){d=j.x;m=j.y;if(!a){a=i(l.draw,e.toolDrawDelay)}k=q.shiftKey;p=false;c.statusShow("rectangleMousedown");return true};this.mousemove=function(q){k=q.shiftKey;p=true};this.draw=function(){if(!p){return}b.clearRect(0,0,g.width,g.height);var q=n(j.x,d),t=n(j.y,m),r=h(j.x-d),s=h(j.y-m);if(!r||!s){p=false;return}if(k){if(r>s){if(t==j.y){t-=r-s}s=r}else{if(q==j.x){q-=s-r}r=s}}if(e.shapeType!="stroke"){b.fillRect(q,t,r,s)}if(e.shapeType!="fill"){b.strokeRect(q,t,r,s)}p=false};this.mouseup=function(q){if(j.x==d&&j.y==m){j.buttonDown=true;return true}if(a){o(a);a=null}k=q.shiftKey;l.draw();f.layerUpdate();c.statusShow("rectangleActive");return true};this.keydown=function(q){if(!j.buttonDown||q.kid_!="Escape"){return false}if(a){o(a);a=null}b.clearRect(0,0,g.width,g.height);j.buttonDown=false;p=false;c.statusShow("rectangleActive");return true}};pwlib.tools.selection=function(e){var k=this,r=pwlib.appEvent,n=e.buffer.context,Q=e.win.clearInterval,F=e.config.selection,I=e.gui,h=e.image,i=e.lang,E=e.layer.canvas,v=e.layer.context,b=null,u=Math.abs,O=Math.min,R=Math.round,z=e.mouse,j=e.win.setInterval,s=e.toolSnapXY;var x=null;var H=false;this.STATE_PENDING=-1;this.STATE_NONE=0;this.STATE_DRAWING=1;this.STATE_SELECTED=2;this.STATE_DRAGGING=3;this.STATE_RESIZING=4;this.state=this.STATE_NONE;var o=0;var c=0;this.selection={x:0,y:0,width:0,height:0,widthOriginal:0,heightOriginal:0,layerCleared:false,marquee:null,context:null,canvas:null};var C="out";var A=null;var y=this.selection,L=F.borderWidth*2,t=null,J=null,p=false,l=false;var G=null;this.preActivate=function(){if(!("canvasContainer" in I.elems)){alert(i.errorToolActivate);return false}y.canvas=e.doc.createElement("canvas");if(!y.canvas){alert(i.errorToolActivate);return false}y.canvas.width=5;y.canvas.height=5;y.context=y.canvas.getContext("2d");if(!y.context){alert(i.errorToolActivate);return false}y.marquee=e.doc.createElement("div");if(!y.marquee){alert(i.errorToolActivate);return false}y.marquee.className=I.classPrefix+"selectionMarquee";b=y.marquee.style;return true};this.activate=function(){if(!v.putImageData||!v.getImageData){F.transparent=true}B();b.borderWidth=F.borderWidth+"px";y.marquee.addEventListener("mousedown",m,false);y.marquee.addEventListener("mousemove",q,false);y.marquee.addEventListener("mouseup",g,false);I.elems.canvasContainer.appendChild(y.marquee);e.shadowDisallow();t=e.events.add("canvasSizeChange",d);J=e.events.add("configChange",w);e.commandRegister("selectionCrop",k.selectionCrop);e.commandRegister("selectionDelete",k.selectionDelete);e.commandRegister("selectionFill",k.selectionFill);if(!x){x=j(P,e.config.toolDrawDelay)}return true};this.deactivate=function(){if(x){Q(x);x=null}k.selectionMerge();y.marquee.removeEventListener("mousedown",m,false);y.marquee.removeEventListener("mousemove",q,false);y.marquee.removeEventListener("mouseup",g,false);b=null;I.elems.canvasContainer.removeChild(y.marquee);delete y.context,y.canvas,y.marquee;e.shadowAllow();if(t){e.events.remove("canvasSizeChange",t)}if(J){e.events.remove("configChange",J)}e.commandUnregister("selectionCrop");e.commandUnregister("selectionDelete");e.commandUnregister("selectionFill");return true};this.mousedown=function(S){if(k.state!==k.STATE_NONE&&k.state!==k.STATE_SELECTED){return false}o=z.x;c=z.y;l=S.shiftKey;p=S.ctrlKey;G=null;if(k.state===k.STATE_NONE){k.state=k.STATE_DRAWING;b.display="";I.statusShow("selectionDraw");return true}f();switch(C){case"out":k.state=k.STATE_PENDING;B();I.statusShow("selectionActive");K();return true;case"in":k.state=k.STATE_DRAGGING;I.statusShow("selectionDrag");break;case"border":k.state=k.STATE_RESIZING;I.statusShow("selectionResize")}if(S.ctrlKey){F.transform=!F.transform}if(y.layerCleared&&!F.transform){K()}else{if(!y.layerCleared&&F.transform){N()}}return true};this.mousemove=function(S){l=S.shiftKey;H=true};function P(){if(!H){return}switch(k.state){case k.STATE_PENDING:k.state=k.STATE_DRAWING;b.display="";I.statusShow("selectionDraw");case k.STATE_DRAWING:D();break;case k.STATE_SELECTED:f();break;case k.STATE_DRAGGING:M();break;case k.STATE_RESIZING:a()}H=false}this.mouseup=function(S){if(k.state!==k.STATE_PENDING&&z.x===o&&z.y===c){return true}H=false;l=S.shiftKey;if(p){F.transform=!F.transform}if(k.state===k.STATE_PENDING){k.state=k.STATE_NONE;e.events.dispatch(new r.selectionChange(k.state));return true}else{if(!G){k.state=k.STATE_NONE;B();I.statusShow("selectionActive");e.events.dispatch(new r.selectionChange(k.state));return true}}y.x=G.x;y.y=G.y;if("width" in G){y.width=G.width;y.height=G.height}k.state=k.STATE_SELECTED;e.events.dispatch(new r.selectionChange(k.state,y.x,y.y,y.width,y.height));I.statusShow("selectionAvailable");return true};function m(S){if(z.buttonDown){return}z.buttonDown=true;S.preventDefault();k.mousedown(S)}function q(S){if("layerX" in S){z.x=R((this.offsetLeft+S.layerX)/h.canvasScale);z.y=R((this.offsetTop+S.layerY)/h.canvasScale)}else{if("offsetX" in S){z.x=R((this.offsetLeft+S.offsetX)/h.canvasScale);z.y=R((this.offsetTop+S.offsetY)/h.canvasScale)}}l=S.shiftKey;H=true}function g(S){if(!z.buttonDown){return}z.buttonDown=false;S.preventDefault();k.mouseup(S)}function B(){b.display="none";b.top="-"+(L+50)+"px";b.left="-"+(L+50)+"px";b.width="1px";b.height="1px";b.cursor=""}function D(){var S=O(z.x,o),X=O(z.y,c),T=u(z.x-o),V=u(z.y-c);if(l){if(T>V){if(X===z.y){X-=T-V}V=T}else{if(S===z.x){S-=V-T}T=V}}var W=T*h.canvasScale-L,U=V*h.canvasScale-L;if(W<1||U<1){G=null;return}b.top=(X*h.canvasScale)+"px";b.left=(S*h.canvasScale)+"px";b.width=W+"px";b.height=U+"px";G={x:S,y:X,width:T,height:V}}function M(){if(l){s(o,c)}var S=y.x+z.x-o,T=y.y+z.y-c;if(F.transform){n.clearRect(0,0,h.width,h.height);if(!F.transparent){n.fillRect(S,T,y.width,y.height)}n.drawImage(y.canvas,S,T,y.width,y.height)}b.top=(T*h.canvasScale)+"px";b.left=(S*h.canvasScale)+"px";G={x:S,y:T}}function a(){var U=z.x-o,T=z.y-c,aa=y.x,Z=y.y,ab=y.width,W=y.height;switch(A){case"nw":aa+=U;Z+=T;ab-=U;W-=T;break;case"n":Z+=T;W-=T;break;case"ne":Z+=T;ab+=U;W-=T;break;case"e":ab+=U;break;case"se":ab+=U;W+=T;break;case"s":W+=T;break;case"sw":aa+=U;ab-=U;W+=T;break;case"w":aa+=U;ab-=U;break;default:G=null;return}if(!ab||!W){G=null;return}if(l){var S=y.width/y.height,V=ab,Y=W;switch(A.charAt(0)){case"n":case"s":V=R(W*S);break;default:Y=R(ab/S)}switch(A){case"nw":case"sw":aa-=V-ab;Z-=Y-W}ab=V;W=Y}if(ab<0){aa+=ab;ab*=-1}if(W<0){Z+=W;W*=-1}var ac=ab*h.canvasScale-L,X=W*h.canvasScale-L;if(ac<1||X<1){G=null;return}if(F.transform){n.clearRect(0,0,h.width,h.height);if(!F.transparent){n.fillRect(aa,Z,ab,W)}n.drawImage(y.canvas,aa,Z,ab,W)}b.top=(Z*h.canvasScale)+"px";b.left=(aa*h.canvasScale)+"px";b.width=ac+"px";b.height=X+"px";G={x:aa,y:Z,width:ab,height:W}}function f(){var X=F.borderWidth/h.canvasScale,ab="",U=y.x+y.width,Z=y.y+y.height,T=U-X,S=Z-X,V=y.x,aa=y.y,Y=y.x+X,W=y.y+X;C="out";if(z.x<T&&z.y<S&&z.x>Y&&z.y>W){ab="move";C="in"}else{if(z.x>=V&&z.x<=U&&z.y>=aa&&z.y<=W){ab="n"}else{if(z.x>=V&&z.x<=U&&z.y>=S&&z.y<=Z){ab="s"}}if(z.y>=aa&&z.y<=Z&&z.x>=V&&z.x<=Y){ab+="w"}else{if(z.y>=aa&&z.y<=Z&&z.x>=T&&z.x<=U){ab+="e"}}if(ab!==""){A=ab;ab+="-resize";C="border"}}if(ab!==b.cursor){b.cursor=ab}}function d(S){if(k.state!==k.STATE_SELECTED){return}b.top=(y.y*S.scale)+"px";b.left=(y.x*S.scale)+"px";b.width=(y.width*S.scale-L)+"px";b.height=(y.height*S.scale-L)+"px"}function w(S){if(S.group!=="selection"||S.config!=="transparent"||!F.transform||k.state!==k.STATE_SELECTED){return}if(!y.layerCleared){N()}n.clearRect(y.x,y.y,y.width,y.height);if(!S.value){n.fillRect(y.x,y.y,y.width,y.height)}n.drawImage(y.canvas,y.x,y.y,y.width,y.height)}function N(){var S=y.x,Z=y.y,U=y.width,W=y.height,Y=y.x+y.width,X=y.y+y.height,V=0,T=0;y.widthOriginal=U;y.heightOriginal=W;if(S<0){U+=S;V-=S;S=0}if(Z<0){W+=Z;T-=Z;Z=0}if(Y>h.width){U=h.width-y.x}if(X>h.height){W=h.height-y.y}if(!F.transparent){n.fillRect(S,Z,U,W)}n.drawImage(E,S,Z,U,W,S,Z,U,W);y.canvas.width=y.widthOriginal;y.canvas.height=y.heightOriginal;y.context.drawImage(E,S,Z,U,W,V,T,U,W);v.clearRect(S,Z,U,W);y.layerCleared=true;e.historyAdd()}function K(){if(!y.layerCleared){return}if(!F.transparent){v.fillRect(y.x,y.y,y.width,y.height)}v.drawImage(y.canvas,y.x,y.y,y.width,y.height);n.clearRect(y.x,y.y,y.width,y.height);y.layerCleared=false;y.canvas.width=5;y.canvas.height=5;e.historyAdd()}this.selectionMerge=function(){if(k.state!==k.STATE_SELECTED){return false}K();k.state=k.STATE_NONE;B();I.statusShow("selectionActive");e.events.dispatch(new r.selectionChange(k.state));return true};this.selectAll=function(){if(k.state!==k.STATE_NONE&&k.state!==k.STATE_SELECTED){return false}if(k.state===k.STATE_SELECTED){K()}else{k.state=k.STATE_SELECTED;b.display=""}y.x=0;y.y=0;y.width=h.width;y.height=h.height;b.top="0px";b.left="0px";b.width=(y.width*h.canvasScale-L)+"px";b.height=(y.height*h.canvasScale-L)+"px";f();e.events.dispatch(new r.selectionChange(k.state,y.x,y.y,y.width,y.height));return true};this.selectionCut=function(){if(!k.selectionCopy()){return false}if(y.layerCleared){n.clearRect(y.x,y.y,y.width,y.height);y.canvas.width=5;y.canvas.height=5;y.layerCleared=false}else{v.clearRect(y.x,y.y,y.width,y.height);e.historyAdd()}k.state=k.STATE_NONE;B();e.events.dispatch(new r.selectionChange(k.state));I.statusShow("selectionActive");return true};this.selectionCopy=function(){if(k.state!==k.STATE_SELECTED){return false}if(!v.getImageData||!v.putImageData){alert(i.errorClipboardUnsupported);return false}if(!y.layerCleared){var S=y.width,T=y.height,V=y.width+y.x;sumY=y.height+y.y;if(V>h.width){S=h.width-y.x}if(sumY>h.height){T=h.height-y.y}try{e.clipboard=v.getImageData(y.x,y.y,S,T)}catch(U){alert(i.failedSelectionCopy);return false}}else{try{e.clipboard=y.context.getImageData(0,0,y.widthOriginal,y.heightOriginal)}catch(U){alert(i.failedSelectionCopy);return false}}e.events.dispatch(new r.clipboardUpdate(e.clipboard));return true};this.clipboardPaste=function(){if(!e.clipboard||k.state!==k.STATE_NONE&&k.state!==k.STATE_SELECTED){return false}if(!v.getImageData||!v.putImageData){alert(i.errorClipboardUnsupported);return false}var S=R(I.elems.viewport.scrollLeft/h.canvasScale),V=R(I.elems.viewport.scrollTop/h.canvasScale),T=e.clipboard.width,U=e.clipboard.height;y.canvas.width=T;y.canvas.height=U;y.context.putImageData(e.clipboard,0,0);if(k.state===k.STATE_SELECTED){n.clearRect(y.x,y.y,y.width,y.height)}else{k.state=k.STATE_SELECTED}if(!F.transparent){n.fillRect(S,V,T,U)}n.drawImage(y.canvas,S,V,T,U);y.widthOriginal=y.width=T;y.heightOriginal=y.height=U;y.x=S;y.y=V;y.layerCleared=true;b.top=(V*h.canvasScale)+"px";b.left=(S*h.canvasScale)+"px";b.width=(T*h.canvasScale-L)+"px";b.height=(U*h.canvasScale-L)+"px";b.display="";if(!F.transform){F.transform=true;e.events.dispatch(new r.configChange(true,false,"transform","selection",F))}f();e.events.dispatch(new r.selectionChange(k.state,y.x,y.y,y.width,y.height));I.statusShow("selectionAvailable");return true};this.selectionDelete=function(){if(k.state!==k.STATE_SELECTED){return false}if(!y.layerCleared){v.clearRect(y.x,y.y,y.width,y.height);e.historyAdd()}else{n.clearRect(y.x,y.y,y.width,y.height);y.layerCleared=false;y.canvas.width=5;y.canvas.height=5;if(F.transform){F.transform=false;e.events.dispatch(new r.configChange(false,true,"transform","selection",F))}}return true};this.selectionDrop=function(){if(k.state!==k.STATE_SELECTED){return false}if(y.layerCleared){n.clearRect(y.x,y.y,y.width,y.height);y.canvas.width=5;y.canvas.height=5;y.layerCleared=false}k.state=k.STATE_NONE;B();I.statusShow("selectionActive");e.events.dispatch(new r.selectionChange(k.state));return true};this.selectionFill=function(){if(k.state!==k.STATE_SELECTED){return false}if(y.layerCleared){y.context.fillStyle=n.fillStyle;y.context.fillRect(0,0,y.widthOriginal,y.heightOriginal);n.fillRect(y.x,y.y,y.width,y.height)}else{v.fillStyle=n.fillStyle;v.fillRect(y.x,y.y,y.width,y.height);e.historyAdd()}return true};this.selectionCrop=function(){if(k.state!==k.STATE_SELECTED){return false}k.selectionMerge();var S=y.width,T=y.height,V=y.x+S,U=y.y+T;if(V>h.width){S-=V-h.width}if(U>h.height){T-=U-h.height}e.imageCrop(y.x,y.y,S,T);return true};this.keydown=function(S){switch(S.kid_){case F.keys.transformToggle:F.transform=!F.transform;e.events.dispatch(new r.configChange(F.transform,!F.transform,"transform","selection",F));break;case F.keys.selectionCrop:return k.selectionCrop(S);case F.keys.selectionDelete:return k.selectionDelete(S);case F.keys.selectionDrop:return k.selectionDrop(S);case F.keys.selectionFill:return k.selectionFill(S);default:return false}return true}};pwlib.appEvent.selectionChange=function(d,b,e,c,a){this.STATE_NONE=0;this.STATE_SELECTED=2;this.state=d;this.x=b;this.y=e;this.width=c;this.height=a;pwlib.appEvent.call(this,"selectionChange")};pwlib.tools.text=function(l){var j=this,o=l.win.clearInterval,x=l.config.text,e=l.buffer.context,z=l.doc,r=l.gui,t=l.image,A=l.lang,w=Math.round,p=l.mouse,b=l.win.setInterval;var n=null;var d=l.tool?l.tool._id:null;var v=false;var y=null,s=null,i=null,h="http://www.w3.org/2000/svg",q=null,k=null,g=0,a=0;this.preActivate=function(){if(!r.inputs.textString||!r.inputs.text_fontFamily||!r.elems.viewport){return false}if(e.fillText&&e.strokeText){return true}if(e.mozPathText){return true}alert(A.errorTextUnsupported);return false};this.activate=function(){p.x=Math.round(r.elems.viewport.scrollLeft/t.canvasScale),p.y=Math.round(r.elems.viewport.scrollTop/t.canvasScale),s=r.inputs.text_fontFamily;y=r.inputs.textString;if(!e.fillText&&pwlib.browser.opera){i=l.events.add("configChange",f);y.addEventListener("input",f,false);y.addEventListener("change",f,false)}else{i=l.events.add("configChange",c);y.addEventListener("input",c,false);y.addEventListener("change",c,false)}if(e.fillText&&e.strokeText){j.draw=j.draw_spec}else{if(pwlib.browser.opera){j.draw=j.draw_opera;m()}else{if(e.mozPathText){j.draw=j.draw_moz;g=e.mozMeasureText(y.value)}}}if(!n){n=b(j.draw,l.config.toolDrawDelay)}v=true};this.deactivate=function(){if(n){o(n);n=null}v=false;if(i){l.events.remove("configChange",i)}if(!e.fillText&&pwlib.browser.opera){y.removeEventListener("input",f,false);y.removeEventListener("change",f,false)}else{y.removeEventListener("input",c,false);y.removeEventListener("change",c,false)}k=null;q=null;e.clearRect(0,0,t.width,t.height);return true};function m(){q=z.createElementNS(h,"svg");q.setAttributeNS(h,"version","1.1");k=z.createElementNS(h,"text");k.appendChild(z.createTextNode(y.value));q.appendChild(k);k.style.font=e.font;if(l.config.shapeType!=="stroke"){k.style.fill=e.fillStyle}else{k.style.fill="none"}if(l.config.shapeType!=="fill"){k.style.stroke=e.strokeStyle;k.style.strokeWidth=e.lineWidth}else{k.style.stroke="none";k.style.strokeWidth=e.lineWidth}g=k.getComputedTextLength();a=k.getBBox().height;q.setAttributeNS(h,"width",g);q.setAttributeNS(h,"height",a+10);k.setAttributeNS(h,"x",0);k.setAttributeNS(h,"y",a)}function c(C){if(C.type==="input"||C.type==="change"||(!C.group&&C.config==="shapeType")||(C.group==="line"&&C.config==="lineWidth")){v=true;if(!e.fillText&&e.mozMeasureText){g=e.mozMeasureText(y.value)}return}if(C.type!=="configChange"&&C.group!=="text"){return}var B="";switch(C.config){case"fontFamily":if(C.value==="+"){u(C)}case"bold":case"italic":case"fontSize":if(x.bold){B+="bold "}if(x.italic){B+="italic "}B+=x.fontSize+"px "+x.fontFamily;e.font=B;if("mozTextStyle" in e){e.mozTextStyle=B}case"textAlign":case"textBaseline":v=true}if(C.config!=="textAlign"&&C.config!=="textBaseline"&&!e.fillText&&e.mozMeasureText){g=e.mozMeasureText(y.value)}}function f(C){if(C.type==="input"||C.type==="change"){k.replaceChild(z.createTextNode(this.value),k.firstChild);v=true}if(!C.group&&C.config==="shapeType"){if(C.value!=="stroke"){k.style.fill=e.fillStyle}else{k.style.fill="none"}if(C.value!=="fill"){k.style.stroke=e.strokeStyle;k.style.strokeWidth=e.lineWidth}else{k.style.stroke="none";k.style.strokeWidth=e.lineWidth}v=true}if(!C.group&&C.config==="fillStyle"){if(l.config.shapeType!=="stroke"){k.style.fill=C.value;v=true}}if((!C.group&&C.config==="strokeStyle")||(C.group==="line"&&C.config==="lineWidth")){if(l.config.shapeType!=="fill"){k.style.stroke=e.strokeStyle;k.style.strokeWidth=e.lineWidth;v=true}}if(C.type==="configChange"&&C.group==="text"){var B="";switch(C.config){case"fontFamily":if(C.value==="+"){u(C)}case"bold":case"italic":case"fontSize":if(x.bold){B+="bold "}if(x.italic){B+="italic "}B+=x.fontSize+"px "+x.fontFamily;e.font=B;k.style.font=B;case"textAlign":case"textBaseline":v=true}}g=k.getComputedTextLength();a=k.getBBox().height;q.setAttributeNS(h,"width",g);q.setAttributeNS(h,"height",a+10);k.setAttributeNS(h,"x",0);k.setAttributeNS(h,"y",a)}function u(F){var E=prompt(A.promptTextFont)||"";E=E.replace(/^\s+/,"").replace(/\s+$/,"")||F.previousValue;var C,D=E.toLowerCase(),G=s.options.length;for(var B=0;B<G;B++){C=s.options[B];if(C.value.toLowerCase()==D){x.fontFamily=C.value;s.selectedIndex=B;s.value=x.fontFamily;F.value=x.fontFamily;return}}C=z.createElement("option");C.value=E;C.appendChild(z.createTextNode(E));s.insertBefore(C,s.options[G-1]);s.selectedIndex=G-1;s.value=E;F.value=E;x.fontFamily=E}this.mousemove=function(){v=true};this.draw_spec=function(){if(!v){return}e.clearRect(0,0,t.width,t.height);if(l.config.shapeType!="stroke"){e.fillText(y.value,p.x,p.y)}if(l.config.shapeType!="fill"){e.beginPath();e.strokeText(y.value,p.x,p.y);e.closePath()}v=false};this.draw_moz=function(){if(!v){return}e.clearRect(0,0,t.width,t.height);var B=p.x,C=p.y;if(x.textAlign==="center"){B-=w(g/2)}else{if(x.textAlign==="right"){B-=g}}if(x.textBaseline==="top"){C+=x.fontSize}else{if(x.textBaseline==="middle"){C+=w(x.fontSize/2)}}e.setTransform(1,0,0,1,B,C);e.beginPath();e.mozPathText(y.value);if(l.config.shapeType!="stroke"){e.fill()}if(l.config.shapeType!="fill"){e.stroke()}e.closePath();e.setTransform(1,0,0,1,0,0);v=false};this.draw_opera=function(){if(!v){return}e.clearRect(0,0,t.width,t.height);var B=p.x,C=p.y;if(x.textAlign==="center"){B-=w(g/2)}else{if(x.textAlign==="right"){B-=g}}if(x.textBaseline==="bottom"){C-=a}else{if(x.textBaseline==="middle"){C-=w(a/2)}}e.drawImage(q,B,C);v=false};this.click=function(){j.draw();l.layerUpdate()};this.keydown=function(B){if(!d||B.kid_!="Escape"){return false}p.buttonDown=false;l.toolActivate(d,B);return true}};pwlib.extensions.colormixer=function(f){var i=this,e=f.config.colormixer,k=f.doc,b=f.gui,c=f.lang.colormixer,a=Math.floor,d=Math.max,j=Math.min,m=Math.pow,g=Math.round,h=f.resolution.scale;this.elems={controls:null,chartDot:null,slider:null,cpaletteInput:null,cpaletteOutput:null,colorActive:null,colorOld:null};this.panel=null;this.panelInputs=null;this.panelSelector=null;this.context2d=false;this.targetInput=null;this.color={red:0,green:0,blue:0,alpha:0,hex:0,hue:0,sat:0,val:0,cyan:0,magenta:0,yellow:0,black:0,cie_l:0,cie_a:0,cie_b:0};this.inputs={red:null,green:null,blue:null,alpha:null,hex:null,hue:null,sat:null,val:null,cyan:null,magenta:null,yellow:null,black:null,cie_l:null,cie_a:null,cie_b:null};this.abs_max={};var l=[[255,0,0],[255,255,0],[0,255,0],[0,255,255],[0,0,255],[255,0,255],[255,0,0]];this.ckey_active="red";this.ckey_adjoint=false;this.ckey_active_group=false;this.ckey_grouping={red:"rgb",green:"rgb",blue:"rgb",hue:"hsv",sat:"hsv",val:"hsv",cyan:"cmyk",magenta:"cmyk",yellow:"cmyk",black:"cmyk",cie_l:"lab",cie_a:"lab",cie_b:"lab"};this.sliderX=0;this.sliderWidth=0;this.sliderHeight=0;this.sliderSpacing=0;this.chartWidth=0;this.chartHeight=0;this.extensionRegister=function(B){if(!b.elems||!b.elems.colormixer_canvas||!b.floatingPanels||!b.floatingPanels.colormixer||!b.tabPanels||!b.tabPanels.colormixer_inputs||!b.tabPanels.colormixer_selector||!i.init_lab()){return false}i.panel=b.floatingPanels.colormixer;i.panelSelector=b.tabPanels.colormixer_selector;i.panelInputs=b.tabPanels.colormixer_inputs;i.context2d=b.elems.colormixer_canvas.getContext("2d");if(!i.context2d){return false}var w,C,z,o=e.inputValues,s=i.panelInputs.container;if(!s){return false}for(var y in i.inputs){w=s.elements.namedItem("ckey_"+y)||b.inputs["ckey_"+y];if(!w){return false}if(y==="hex"||y==="alpha"){C=c.inputs[y]}else{C=c.inputs[i.ckey_grouping[y]+"_"+y]}z=w.parentNode;z.replaceChild(k.createTextNode(C),z.firstChild);w.addEventListener("input",i.ev_input_change,false);w.addEventListener("change",i.ev_input_change,false);if(y!=="hex"){w.setAttribute("step",o[y][2]);w.setAttribute("max",g(o[y][1]));w.setAttribute("min",g(o[y][0]));i.abs_max[y]=o[y][1]-o[y][0]}w._ckey=y;i.inputs[y]=w}var p=s.ckey;if(!p){return false}for(var y=0,v=p.length;y<v;y++){w=p[y];if(i.ckey_grouping[w.value]==="lab"&&!i.context2d.putImageData){w.disabled=true;continue}w.addEventListener("change",i.ev_change_ckey_active,false);if(w.value===i.ckey_active){w.checked=true;i.update_ckey_active(i.ckey_active,true)}}i.elems.colorActive=b.elems.colormixer_colorActive.firstChild;i.elems.colorOld=b.elems.colormixer_colorOld.firstChild;i.elems.colorOld.addEventListener("click",i.ev_click_color,false);var x,t,A=["accept","cancel","saveColor","pickColor"];for(var y=0,v=A.length;y<v;y++){t=b.elems["colormixer_btn_"+A[y]];if(!t){continue}x=k.createElement("a");x.href="#";x.appendChild(k.createTextNode(c.buttons[A[y]]));x.addEventListener("click",i["ev_click_"+A[y]],false);t.replaceChild(x,t.firstChild)}var r,q=["controls","chartDot","slider"];for(var y=0,v=q.length;y<v;y++){r=q[y];w=b.elems["colormixer_"+r];if(!w){return false}w.addEventListener("mousedown",i.ev_canvas,false);w.addEventListener("mousemove",i.ev_canvas,false);w.addEventListener("mouseup",i.ev_canvas,false);i.elems[r]=w}i.elems.cpaletteInput=b.inputs.colormixer_cpaletteInput;i.elems.cpaletteInput.addEventListener("change",i.ev_change_cpalette,false);var u;for(var y in e.colorPalettes){u=e.colorPalettes[y];w=k.createElement("option");w.value=y;if(y===e.paletteDefault){w.selected=true}w.appendChild(k.createTextNode(c.colorPalettes[y]));i.elems.cpaletteInput.appendChild(w)}i.elems.cpaletteOutput=b.elems.colormixer_cpaletteOutput;i.elems.cpaletteOutput.addEventListener("click",i.ev_click_color,false);i.cpalette_load(e.paletteDefault);f.events.add("canvasSizeChange",i.update_dimensions);i.panelSelector.events.add("guiTabActivate",i.ev_tabActivate);i.panel.events.add("guiFloatingPanelStateChange",i.ev_panel_stateChange);return true};this.init_lab=function(){var q=e.lab;if(!q){return false}var t=q.x_r,w=q.y_r,z=q.x_g,I=q.y_g,H=q.x_b,K=q.y_b,C=q.ref_x/q.ref_y,B=1,A=(1-q.ref_x-q.ref_y)/q.ref_y;q.w_x=C;q.w_y=B;q.w_z=A;var r=t/w,L=1,v=(1-t-w)/w,x=z/I,n=1,D=(1-z-I)/I,E=H/K,p=1,J=(1-H-K)/K,G=[r,L,v,x,n,D,E,p,J],u=i.calc_m3inv(G),y=i.calc_m1x3([C,B,A],u);G=[y[0]*G[0],y[0]*G[1],y[0]*G[2],y[1]*G[3],y[1]*G[4],y[1]*G[5],y[2]*G[6],y[2]*G[7],y[2]*G[8]];q.m_i=i.calc_m3inv(G);q.m=G;var M=i.rgb2xyz([0,1,0]),F=i.xyz2lab(M),o=e.inputValues;o.cie_a[0]=F[1];M=i.rgb2xyz([1,0,1]);F=i.xyz2lab(M);o.cie_a[1]=F[1];M=i.rgb2xyz([0,0,1]);F=i.xyz2lab(M);o.cie_b[0]=F[2];M=i.rgb2xyz([1,1,0]);F=i.xyz2lab(M);o.cie_b[1]=F[2];return true};this.ev_tabActivate=function(n){if(n.tabId==="mixer"&&i.update_canvas_needed){i.update_canvas(null,true)}};this.ev_click_accept=function(p){p.preventDefault();var s=i.targetInput.configProperty,q=i.targetInput.configGroup,o=i.targetInput.configGroupRef,r=o[s],n="rgba("+g(i.color.red*255)+","+g(i.color.green*255)+","+g(i.color.blue*255)+","+i.color.alpha+")";i.hide();if(r!==n){o[s]=n;f.events.dispatch(new pwlib.appEvent.configChange(n,r,s,q,o))}};this.ev_click_cancel=function(n){n.preventDefault();i.hide()};this.ev_click_saveColor=function(p){p.preventDefault();var n=[i.color.red,i.color.green,i.color.blue],o=e.colorPalettes._saved;o.colors.push(n);i.elems.cpaletteInput.value="_saved";i.cpalette_load("_saved");i.panelSelector.tabActivate("cpalettes");return true};this.ev_click_pickColor=function(n){n.preventDefault();f.toolActivate("cpicker",n)};this.ev_change_cpalette=function(n){i.cpalette_load(this.value)};this.cpalette_load=function(o){if(!o||!(o in e.colorPalettes)){return false}var n=e.colorPalettes[o];if(n.file){pwlib.xhrLoad(PaintWeb.baseFolder+n.file,this.cpalette_loaded);return true}else{if(n.colors){return this.cpalette_show(n.colors)}else{return false}}};this.cpalette_loaded=function(o){if(!o||o.readyState!==4){return}if((o.status!==304&&o.status!==200)||!o.responseText){alert(c.failedColorPaletteLoad);return}var n=JSON.parse(o.responseText);o=null;i.cpalette_show(n)};this.cpalette_show=function(p){if(!p||!(p instanceof Array)){return false}var q,s,o,v=k.createDocumentFragment(),r=this.elems.cpaletteOutput;r.style.display="none";while(r.hasChildNodes()){r.removeChild(r.firstChild)}for(var t=0,u=p.length;t<u;t++){q=p[t];q[0]=j(1,q[0]);q[1]=j(1,q[1]);q[2]=j(1,q[2]);o="rgb("+g(q[0]*255)+","+g(q[1]*255)+","+g(q[2]*255)+")";s=k.createElement("a");s.href="#";s._color=q;s.style.backgroundColor=o;s.appendChild(k.createTextNode(o));v.appendChild(s)}r.appendChild(v);r.style.display="block";p=v=null;return true};this.ev_click_color=function(o){var n=o.target._color;if(!n){return}o.preventDefault();i.color.red=n[0];i.color.green=n[1];i.color.blue=n[2];if(typeof(n[3])!=="undefined"){i.color.alpha=n[3]}i.update_color("rgb")};this.update_dimensions=function(){if(h===f.resolution.scale){return}h=f.resolution.scale;var o=i.context2d.canvas,r=o.width,n=o.height,s=r/h,p=n/h,q;i.sliderWidth=g(r*e.sliderWidth);i.sliderHeight=n-1;i.sliderSpacing=g(r*e.sliderSpacing);i.sliderX=r-i.sliderWidth-2;i.chartWidth=i.sliderX-i.sliderSpacing;i.chartHeight=n;q=i.elems.controls.style;q.width=s+"px";q.height=p+"px";q=i.elems.slider.style;q.width=(i.sliderWidth/h)+"px";q.left=(i.sliderX/h)+"px";q=o.style;q.width=s+"px";q.height=p+"px";if(i.panel.state!==i.panel.STATE_HIDDEN){i.update_canvas()}};this.calc_m1x3=function(o,n){if(!(o instanceof Array)||!(n instanceof Array)){return false}else{return[o[0]*n[0]+o[1]*n[3]+o[2]*n[6],o[0]*n[1]+o[1]*n[4]+o[2]*n[7],o[0]*n[2]+o[1]*n[5]+o[2]*n[8]]}};this.calc_m3inv=function(n){if(!(n instanceof Array)){return false}var p=(n[0]*n[4]*n[8]+n[1]*n[5]*n[6]+n[2]*n[3]*n[7])-(n[2]*n[4]*n[6]+n[5]*n[7]*n[0]+n[8]*n[1]*n[3]);if(p===0){return false}var o=[n[4]*n[8]-n[5]*n[7],-n[3]*n[8]+n[5]*n[6],n[3]*n[7]-n[4]*n[6],-n[1]*n[8]+n[2]*n[7],n[0]*n[8]-n[2]*n[6],-n[0]*n[7]+n[1]*n[6],n[1]*n[5]-n[2]*n[4],-n[0]*n[5]+n[2]*n[3],n[0]*n[4]-n[1]*n[3]];o=[1/p*o[0],1/p*o[3],1/p*o[6],1/p*o[1],1/p*o[4],1/p*o[7],1/p*o[2],1/p*o[5],1/p*o[8]];return o};this.ev_change_ckey_active=function(){if(this.value&&this.value!==i.ckey_active){i.update_ckey_active(this.value)}};this.update_ckey_active=function(o,r){if(!i.inputs[o]){return false}i.ckey_active=o;var q=[],p=i.ckey_grouping[o];for(var n in i.ckey_grouping){if(i.ckey_grouping[n]===p&&n!==o){q.push(n)}}i.ckey_active_group=p;i.ckey_adjoint=q;if(!r){if(i.panelSelector.tabId!=="mixer"){i.update_canvas_needed=true;i.panelSelector.tabActivate("mixer")}else{i.update_canvas()}if(i.panelInputs.tabId!==p){i.panelInputs.tabActivate(p)}}return true};this.show=function(r,o){var q=i.elems.colorActive.style,p=i.elems.colorOld,n=p.style;if(r){if(i.targetInput){i.targetInput.hide()}i.targetInput=r;i.targetInput.show()}if(o){i.color.red=o.red;i.color.green=o.green;i.color.blue=o.blue;i.color.alpha=o.alpha;i.update_color("rgb");n.backgroundColor=q.backgroundColor;n.opacity=q.opacity;p._color=[o.red,o.green,o.blue,o.alpha]}i.panel.show()};this.hide=function(){i.panel.hide();i.ev_canvas_mode=false};this.ev_panel_stateChange=function(n){if(n.state===n.STATE_HIDDEN){if(i.targetInput){i.targetInput.hide();i.targetInput=null}i.ev_canvas_mode=false}};this.ev_input_change=function(){if(!this._ckey){return}if((this._ckey==="hex"&&!/^\#[a-f0-9]{6}$/i.test(this.value))){return}if(this.getAttribute("type")==="number"){var p=parseInt(this.value),o=this.getAttribute("min"),n=this.getAttribute("max");if(isNaN(p)){p=o}if(p<o){p=o}else{if(p>n){p=n}}if(p!=this.value){this.value=p}}if(this._ckey==="hex"){i.color[this._ckey]=this.value}else{if(i.ckey_grouping[this._ckey]==="lab"){i.color[this._ckey]=parseInt(this.value)}else{i.color[this._ckey]=parseInt(this.value)/e.inputValues[this._ckey][1]}}i.update_color(this._ckey)};this.update_color=function(n){var o=i.ckey_grouping[n]||n;switch(o){case"rgb":i.rgb2hsv();i.rgb2hex();i.rgb2lab();i.rgb2cmyk();break;case"hsv":i.hsv2rgb();i.rgb2hex();i.rgb2lab();i.rgb2cmyk();break;case"hex":i.hex2rgb();i.rgb2hsv();i.rgb2lab();i.rgb2cmyk();break;case"lab":i.lab2rgb();i.rgb2hsv();i.rgb2hex();i.rgb2cmyk();break;case"cmyk":i.cmyk2rgb();i.rgb2lab();i.rgb2hsv();i.rgb2hex()}i.update_preview();i.update_inputs();if(n!=="alpha"){i.update_canvas(n)}};this.update_preview=function(){var q=g(i.color.red*255),p=g(i.color.green*255),n=g(i.color.blue*255),o=i.elems.colorActive.style;o.backgroundColor="rgb("+q+","+p+","+n+")";o.opacity=i.color.alpha};this.update_inputs=function(){var n;for(var o in i.inputs){n=i.inputs[o];n._old_value=n.value;if(n._ckey==="hex"){n.value=i.color[o]}else{if(i.ckey_grouping[n._ckey]==="lab"){n.value=g(i.color[o])}else{n.value=g(i.color[o]*e.inputValues[o][1])}}}};this.rgb2cmyk=function(){var q=i.color,u,v,s,n,o=q.red,p=q.green,t=q.blue;u=1-o;v=1-p;s=1-t;n=j(u,v,s,1);if(n===1){u=v=s=0}else{var r=1-n;u=(u-n)/r;v=(v-n)/r;s=(s-n)/r}q.cyan=u;q.magenta=v;q.yellow=s;q.black=n};this.cmyk2rgb=function(){var o=i.color,n=1-o.black;o.red=1-o.cyan*n-o.black;o.green=1-o.magenta*n-o.black;o.blue=1-o.yellow*n-o.black};this.rgb2hsv=function(){var s,o,n,p=i.color.red,q=i.color.green,u=i.color.blue,r=j(p,q,u),t=d(p,q,u),v=t-r,n=t;if(v===0){s=o=0}else{o=v/t;if(t===p){s=(q-u)/v}else{if(t===q){s=(u-p)/v+2}else{if(t===u){s=(p-q)/v+4}}}s/=6;if(s<0){s+=1}}i.color.hue=s;i.color.sat=o;i.color.val=n};this.hsv2rgb=function(z,w){var r=i.color,p,q,A,y,o,n;if(w){y=w[0];o=w[1];n=w[2]}else{y=r.hue,o=r.sat,n=r.val}if(o===0){p=q=A=n}else{var v=y*6;var t=a(v);var x=n*(1-o),u=n*(1-o*(v-t)),s=n*(1-o*(1-(v-t)));if(t===0||t===6){p=n;q=s;A=x}else{if(t===1){p=u;q=n;A=x}else{if(t===2){p=x;q=n;A=s}else{if(t===3){p=x;q=u;A=n}else{if(t===4){p=s;q=x;A=n}else{if(t===5){p=n;q=x;A=u}}}}}}}if(!z){r.red=p;r.green=q;r.blue=A}return[p,q,A]};this.rgb2hex=function(){var q="#",o=["red","green","blue"],p,r,n=i.color;for(p=0;p<3;p++){r=g(n[o[p]]*255).toString(16);if(r.length===1){r="0"+r}q+=r}n.hex=q};this.hex2rgb=function(){var o=["red","green","blue"],p,r,n=i.color,q=n.hex;q=q.substr(1);if(q.length!==6){return}for(p=0;p<3;p++){r=q.substr(p*2,2);n[o[p]]=parseInt(r,16)/255}};this.rgb2lab=function(){var n=i.color,o=i.xyz2lab(i.rgb2xyz([n.red,n.green,n.blue]));n.cie_l=o[0];n.cie_a=o[1];n.cie_b=o[2]};this.lab2rgb=function(){var n=i.color,o=i.xyz2rgb(i.lab2xyz(n.cie_l,n.cie_a,n.cie_b));n.red=o[0];n.green=o[1];n.blue=o[2]};this.xyz2lab=function(r){var p=e.lab,s=216/24389,q=24389/27;r[0]/=p.w_x;r[1]/=p.w_y;r[2]/=p.w_z;if(r[0]>s){r[0]=m(r[0],1/3)}else{r[0]=(q*r[0]+16)/116}if(r[1]>s){r[1]=m(r[1],1/3)}else{r[1]=(q*r[1]+16)/116}if(r[2]>s){r[2]=m(r[2],1/3)}else{r[2]=(q*r[2]+16)/116}var o=116*r[1]-16,n=500*(r[0]-r[1]),t=200*(r[1]-r[2]);return[o,n,t]};this.lab2xyz=function(n,u,r){var v=(n+16)/116,w=v+u/500,s=v-r/200,q=6/29,o=1/3*m(29/6,2),A=16/116,p=e.lab;if(w>q){w=m(w,3)}else{w=(w-A)/o}if(v>q){v=m(v,3)}else{v=(v-A)/o}if(s>q){s=m(s,3)}else{s=(s-A)/o}w*=p.w_x;v*=p.w_y;s*=p.w_z;return[w,v,s]};this.xyz2rgb=function(n){var o=i.calc_m1x3(n,e.lab.m_i);if(o[0]>0.0031308){o[0]=1.055*m(o[0],1/2.4)-0.055}else{o[0]*=12.9232}if(o[1]>0.0031308){o[1]=1.055*m(o[1],1/2.4)-0.055}else{o[1]*=12.9232}if(o[2]>0.0031308){o[2]=1.055*m(o[2],1/2.4)-0.055}else{o[2]*=12.9232}if(o[0]<0){o[0]=0}else{if(o[0]>1){o[0]=1}}if(o[1]<0){o[1]=0}else{if(o[1]>1){o[1]=1}}if(o[2]<0){o[2]=0}else{if(o[2]>1){o[2]=1}}return o};this.rgb2xyz=function(n){if(n[0]>0.04045){n[0]=m((n[0]+0.055)/1.055,2.4)}else{n[0]/=12.9232}if(n[1]>0.04045){n[1]=m((n[1]+0.055)/1.055,2.4)}else{n[1]/=12.9232}if(n[2]>0.04045){n[2]=m((n[2]+0.055)/1.055,2.4)}else{n[2]/=12.9232}return i.calc_m1x3(n,e.lab.m)};this.update_canvas=function(u,p){if(i.panelSelector.tabId!=="mixer"&&!p){i.update_canvas_needed=true;return true}i.update_canvas_needed=false;var q=i.elems.slider.style,t=i.elems.chartDot.style,r=i.color,n=i.ckey_active,y=i.ckey_active_group,s=i.ckey_adjoint,o=i.chartWidth/h,z=i.chartHeight/h,x,w,v;if(u!==s[0]&&u!==s[1]&&i.ev_canvas_mode!=="chart"){if(y==="lab"){v=(r[n]-e.inputValues[n][0])/i.abs_max[n]}else{v=r[n]}if(n!=="hue"&&y!=="lab"){v=1-v}q.top=g(v*z)+"px"}if(u!==n){if(y==="lab"){x=(r[s[0]]-e.inputValues[s[0]][0])/i.abs_max[s[0]];w=(r[s[1]]-e.inputValues[s[1]][0])/i.abs_max[s[1]]}else{x=r[s[0]];w=1-r[s[1]]}t.top=g(w*z)+"px";t.left=g(x*o)+"px"}if(!i.draw_chart(u)||!i.draw_slider(u)){return false}else{return true}};this.ev_canvas=function(s){s.preventDefault();if(s.type==="mousedown"&&!i.ev_canvas_mode){i.ev_canvas_mode=true;k.addEventListener("mouseup",i.ev_canvas,false)}if(!i.ev_canvas_mode){return false}if(s.type==="mouseup"){i.ev_canvas_mode=false;k.removeEventListener("mouseup",i.ev_canvas,false)}var n=i.elems;if(s.target===n.controls){var u,t,o=i.context2d.canvas.width,v=i.context2d.canvas.height;if(s.layerX||s.layerX===0){u=s.layerX*h;t=s.layerY*h}else{if(s.offsetX||s.offsetX===0){u=s.offsetX*h;t=s.offsetY*h}}if(u>=0&&u<=i.chartWidth){mode="chart"}else{if(u>=i.sliderX&&u<=o){mode="slider"}}}else{if(s.target===n.chartDot){mode="chart"}else{if(s.target===n.slider){mode="slider"}}}if(mode&&i.ev_canvas_mode===true){i.ev_canvas_mode=mode}if(!mode||i.ev_canvas_mode!==mode||s.target!==n.controls){return false}var p=i.color,r=u/i.chartWidth,q=t/v;if(mode==="slider"){if(i.ckey_active==="hue"){p[i.ckey_active]=q}else{if(i.ckey_active_group==="lab"){p[i.ckey_active]=i.abs_max[i.ckey_active]*q+e.inputValues[i.ckey_active][0]}else{p[i.ckey_active]=1-q}}return i.update_color(i.ckey_active)}else{if(mode==="chart"){if(r>1){return false}if(i.ckey_active_group==="lab"){r=i.abs_max[i.ckey_adjoint[0]]*r+e.inputValues[i.ckey_adjoint[0]][0];q=i.abs_max[i.ckey_adjoint[1]]*q+e.inputValues[i.ckey_adjoint[1]][0]}else{q=1-q}p[i.ckey_adjoint[0]]=r;p[i.ckey_adjoint[1]]=q;return i.update_color(i.ckey_active_group)}}return false};this.draw_chart=function(r){var s=i.context2d,q,E,u,F;if(r===i.ckey_adjoint[0]||r===i.ckey_adjoint[1]||(i.ev_canvas_mode==="chart"&&r===i.ckey_active_group)){return true}var z=i.chartWidth,H=i.chartHeight;s.clearRect(0,0,z,H);if(i.ckey_active==="sat"){if(i.color.sat>0){q=s.createLinearGradient(0,0,z,0);for(F=0;F<=6;F++){E="rgb("+l[F][0]+", "+l[F][1]+", "+l[F][2]+")";q.addColorStop(F*1/6,E)}s.fillStyle=q;s.fillRect(0,0,z,H);q=s.createLinearGradient(0,0,0,H);q.addColorStop(0,"rgba(0, 0, 0, 0)");q.addColorStop(1,"rgba(0, 0, 0, 1)");s.fillStyle=q;s.fillRect(0,0,z,H)}if(i.color.sat<1){u=1-i.color.sat;q=s.createLinearGradient(0,0,0,H);q.addColorStop(0,"rgba(255, 255, 255, "+u+")");q.addColorStop(1,"rgba(  0,   0,   0, "+u+")");s.fillStyle=q;s.fillRect(0,0,z,H)}}else{if(i.ckey_active==="val"){if(i.color.val>0){q=s.createLinearGradient(0,0,z,0);for(F=0;F<=6;F++){E="rgb("+l[F][0]+", "+l[F][1]+", "+l[F][2]+")";q.addColorStop(F*1/6,E)}s.fillStyle=q;s.fillRect(0,0,z,H);q=s.createLinearGradient(0,0,0,H);q.addColorStop(0,"rgba(255, 255, 255, 0)");q.addColorStop(1,"rgba(255, 255, 255, 1)");s.fillStyle=q;s.fillRect(0,0,z,H)}if(i.color.val<1){s.fillStyle="rgba(0, 0, 0, "+(1-i.color.val)+")";s.fillRect(0,0,z,H)}}else{if(i.ckey_active==="hue"){if(i.color.sat===1&&i.color.val===1){E=[i.color.red,i.color.green,i.color.blue]}else{E=i.hsv2rgb(true,[i.color.hue,1,1])}for(F=0;F<3;F++){E[F]=g(E[F]*255)}s.fillStyle="rgb("+E[0]+", "+E[1]+", "+E[2]+")";s.fillRect(0,0,z,H);q=s.createLinearGradient(0,0,z,0);q.addColorStop(0,"rgba(255, 255, 255, 1)");q.addColorStop(1,"rgba(255, 255, 255, 0)");s.fillStyle=q;s.fillRect(0,0,z,H);q=s.createLinearGradient(0,0,0,H);q.addColorStop(0,"rgba(0, 0, 0, 0)");q.addColorStop(1,"rgba(0, 0, 0, 1)");s.fillStyle=q;s.fillRect(0,0,z,H)}else{if(i.ckey_active_group==="rgb"){var I,G;E={red:0,green:0,blue:0};E[i.ckey_active]=g(i.color[i.ckey_active]*255);I={red:0,green:0,blue:0};I[i.ckey_adjoint[1]]=255;G={red:0,green:0,blue:0};G[i.ckey_adjoint[0]]=255;s.fillStyle="rgb("+E.red+","+E.green+","+E.blue+")";s.fillRect(0,0,z,H);var y=s.globalCompositeOperation;s.globalCompositeOperation="lighter";q=s.createLinearGradient(0,0,0,H);q.addColorStop(0,"rgba("+I.red+","+I.green+","+I.blue+", 1)");q.addColorStop(1,"rgba("+I.red+","+I.green+","+I.blue+", 0)");s.fillStyle=q;s.fillRect(0,0,z,H);q=s.createLinearGradient(0,0,z,0);q.addColorStop(0,"rgba("+G.red+","+G.green+","+G.blue+", 0)");q.addColorStop(1,"rgba("+G.red+","+G.green+","+G.blue+", 1)");s.fillStyle=q;s.fillRect(0,0,z,H);s.globalCompositeOperation=y}else{if(i.ckey_active_group==="lab"){var J=false;if(s.createImageData){J=s.createImageData(z,H)}else{if(s.getImageData){J=s.getImageData(0,0,z,H)}else{J={width:z,height:H,data:new Array(z*H*4)}}}var t=J.data,B=J.data.length-1,F=-1,A=0,D,C,K=[],o=[],x,v;x=i.ckey_adjoint[0];v=i.ckey_adjoint[1];E={cie_l:i.color.cie_l,cie_a:i.color.cie_a,cie_b:i.color.cie_b};D=i.abs_max[x]/z;C=i.abs_max[v]/H;E[x]=e.inputValues[x][0];E[v]=e.inputValues[v][0];while(F<B){K=i.lab2xyz(E.cie_l,E.cie_a,E.cie_b);o=i.xyz2rgb(K);t[++F]=g(o[0]*255);t[++F]=g(o[1]*255);t[++F]=g(o[2]*255);t[++F]=255;A++;E[x]+=D;if((A%z)===0){E[x]=e.inputValues[x][0];E[v]+=C}}s.putImageData(J,0,0)}}}}}return true};this.draw_slider=function(r){if(i.ckey_active===r){return true}var s=i.context2d,y=i.sliderWidth,D=i.sliderHeight,w=i.sliderX,v=0,q,B,E;q=s.createLinearGradient(w,v,w,D);if(i.ckey_active==="hue"){for(E=0;E<=6;E++){B="rgb("+l[E][0]+", "+l[E][1]+", "+l[E][2]+")";q.addColorStop(E*1/6,B)}s.fillStyle=q;s.fillRect(w,v,y,D);if(i.color.sat<1){s.fillStyle="rgba(255, 255, 255, "+(1-i.color.sat)+")";s.fillRect(w,v,y,D)}if(i.color.val<1){s.fillStyle="rgba(0, 0, 0, "+(1-i.color.val)+")";s.fillRect(w,v,y,D)}}else{if(i.ckey_active==="sat"){if(i.color.sat===1){B=[i.color.red,i.color.green,i.color.blue]}else{B=i.hsv2rgb(true,[i.color.hue,1,i.color.val])}for(E=0;E<3;E++){B[E]=g(B[E]*255)}var G=g(i.color.val*255);q.addColorStop(0,"rgb("+B[0]+", "+B[1]+", "+B[2]+")");q.addColorStop(1,"rgb("+G+", "+G+", "+G+")");s.fillStyle=q;s.fillRect(w,v,y,D)}else{if(i.ckey_active==="val"){if(i.color.val===1){B=[i.color.red,i.color.green,i.color.blue]}else{B=i.hsv2rgb(true,[i.color.hue,i.color.sat,1])}for(E=0;E<3;E++){B[E]=g(B[E]*255)}q.addColorStop(0,"rgb("+B[0]+", "+B[1]+", "+B[2]+")");q.addColorStop(1,"rgb(0, 0, 0)");s.fillStyle=q;s.fillRect(w,v,y,D)}else{if(i.ckey_active_group==="rgb"){var u=g(i.color.red*255),z=g(i.color.green*255),o=g(i.color.blue*255);B={red:u,green:z,blue:o};B[i.ckey_active]=255;var F={red:u,green:z,blue:o};F[i.ckey_active]=0;q.addColorStop(0,"rgb("+B.red+","+B.green+","+B.blue+")");q.addColorStop(1,"rgb("+F.red+","+F.green+","+F.blue+")");s.fillStyle=q;s.fillRect(w,v,y,D)}else{if(i.ckey_active_group==="lab"){var H=false;if(s.createImageData){H=s.createImageData(1,D)}else{if(s.getImageData){H=s.getImageData(0,0,1,D)}else{H={width:1,height:D,data:new Array(D*4)}}}var t=H.data,A=H.data.length-1,C=i.ckey_active,E=-1,x,I,p;B={cie_l:i.color.cie_l,cie_a:i.color.cie_a,cie_b:i.color.cie_b};B[C]=e.inputValues[C][0];x=i.abs_max[C]/D;while(E<A){I=i.lab2xyz(B.cie_l,B.cie_a,B.cie_b);p=i.xyz2rgb(I);t[++E]=g(p[0]*255);t[++E]=g(p[1]*255);t[++E]=g(p[2]*255);t[++E]=255;B[C]+=x}for(E=0;E<=y;E++){s.putImageData(H,w+E,v)}}}}}}s.strokeStyle="#6d6d6d";s.strokeRect(w,v,y,D);return true}};pwlib.extensions.mousekeys=function(g){var n=this,d=g.buffer.canvas,e=g.config,b=g.gui.elems.canvasContainer,p=g.doc,c=g.gui,h=g.image,m=Math.ceil,l=g.mouse,k=g.tool||{};var f=1;var j=0.1;var a=null;var o=null;this.extensionRegister=function(){j=e.mousekeys.accel;a=p.createElement("div");if(!a){return false}o=a.style;a.className=c.classPrefix+"mousekeysPointer";o.display="none";b.appendChild(a);d.addEventListener("mousemove",i,false);var t,s,r,u,q={};for(t in e.mousekeys.actions){s=e.mousekeys.actions[t];for(r=0,u=s.length;r<u;r++){q[s[r]]={extension:n._id,action:t}}}pwlib.extend(e.keys,q);return true};this.extensionUnregister=function(){b.removeChild(a);d.removeEventListener("mousemove",i,false);var q,r;for(q in e.keys){r=e.keys[q];if(r.extension===n._id){delete e.keys[q]}}};function i(q){if(!("kobj_" in q)||!("extension" in q.kobj_)||q.kobj_.extension!==n._id){if(o.display==="block"){o.display="none"}}}this.keydown=function(q){f=1;j=e.mousekeys.accel;if(o.display==="none"){o.display="block";o.top=(l.y*h.canvasScale)+"px";o.left=(l.x*h.canvasScale)+"px";if(l.buttonDown){a.className+=" "+c.classPrefix+"mouseDown"}else{a.className=a.className.replace(" "+c.classPrefix+"mouseDown","")}}k=g.tool||{};switch(q.kobj_.action){case"ButtonToggle":if(l.buttonDown){l.buttonDown=false;if("mouseup" in k){k.mouseup(q)}if("click" in k){k.click(q)}}else{l.buttonDown=true;if("mousedown" in k){k.mousedown(q)}}break;case"ButtonClick":if(!l.buttonDown){l.buttonDown=true;if("mousedown" in k){k.mousedown(q)}}break;default:return false}if(l.buttonDown){a.className+=" "+c.classPrefix+"mouseDown"}else{a.className=a.className.replace(" "+c.classPrefix+"mouseDown","")}return true};this.keypress=function(r){if(r.shiftKey){f+=f*j*3}else{f+=f*j}var q=m(f);switch(r.kobj_.action){case"SouthWest":l.x-=q;l.y+=q;break;case"South":l.y+=q;break;case"SouthEast":l.x+=q;l.y+=q;break;case"West":l.x-=q;break;case"East":l.x+=q;break;case"NorthWest":l.x-=q;l.y-=q;break;case"North":l.y-=q;break;case"NorthEast":l.x+=q;l.y-=q;break;default:return false}if(l.x<0){l.x=0}else{if(l.x>h.width){l.x=h.width}}if(l.y<0){l.y=0}else{if(l.y>h.height){l.y=h.height}}o.top=(l.y*h.canvasScale)+"px";o.left=(l.x*h.canvasScale)+"px";if("mousemove" in k){k.mousemove(r)}return true};this.keyup=function(q){if(q.kobj_.action=="ButtonClick"&&l.buttonDown){l.buttonDown=false;if("mouseup" in k){k.mouseup(q)}if("click" in k){k.click(q)}a.className=a.className.replace(" "+c.classPrefix+"mouseDown","");return true}return false}};pwlib.gui=function(c){var g=this,b=c.config,h=c.doc,a=c.lang,d=Math.round,i=window.pwlib,f=i.appEvent,e=c.win;this.app=c;this.idPrefix="paintweb"+c.UID+"_",this.classPrefix="paintweb_";this.elems={};this.inputs={};this.inputValues={};this.colorInputs={};this.tools={};this.commands={};this.floatingPanels={zIndex_:0};this.tabPanels={};this.canvasResizer=null;this.viewportResizer=null;this.toolTabConfig={bcurve:{lineTab:true,shapeType:true,lineWidth:true,lineWidthLabel:a.inputs.borderWidth,lineCap:true},ellipse:{lineTab:true,shapeType:true,lineWidth:true,lineWidthLabel:a.inputs.borderWidth},rectangle:{lineTab:true,shapeType:true,lineWidth:true,lineWidthLabel:a.inputs.borderWidth,lineJoin:true},polygon:{lineTab:true,shapeType:true,lineWidth:true,lineWidthLabel:a.inputs.borderWidth,lineJoin:true,lineCap:true,miterLimit:true},eraser:{lineTab:true,lineWidth:true,lineWidthLabel:a.inputs.eraserSize,lineJoin:true,lineCap:true,miterLimit:true},pencil:{lineTab:true,lineWidth:true,lineWidthLabel:a.inputs.pencilSize,lineJoin:true,lineCap:true,miterLimit:true},line:{lineTab:true,lineWidth:true,lineWidthLabel:a.inputs.line.lineWidth,lineJoin:true,lineCap:true,miterLimit:true},text:{lineTab:true,lineTabLabel:a.tabs.main.textBorder,shapeType:true,lineWidth:true,lineWidthLabel:a.inputs.borderWidth}};this.init=function(k){var o=b.guiPlaceholder,l=o.style;l.display="none";l.height="1px";l.overflow="hidden";l.position="absolute";l.visibility="hidden";o.className+=" "+this.classPrefix+"placeholder";if(!o.tabIndex||o.tabIndex==-1){o.tabIndex=1}if(!this.initImportDoc(k)){c.initError(a.guiMarkupImportFailed);return false}k=null;if(!this.initParseMarkup()){c.initError(a.guiMarkupParseFailed);return false}if(!this.initCanvas()||!this.initImageZoom()||!this.initSelectionTool()||!this.initTextTool()||!this.initKeyboardShortcuts()){return false}var j=this.tabPanels.main;if(!j){c.initError(a.noMainTabPanel);return false}if(!c.shadowSupported&&"shadow" in j.tabs){j.tabHide("shadow")}if(!("viewport" in this.elems)){c.initError(a.missingViewport);return false}this.elems.viewport.style.height=b.viewportHeight;l.width=b.viewportWidth;var m=this.elems.canvasResizer;if(!m){c.initError(a.missingCanvasResizer);return false}m.title=a.guiCanvasResizer;m.replaceChild(h.createTextNode(m.title),m.firstChild);m.addEventListener("mouseover",this.item_mouseover,false);m.addEventListener("mouseout",this.item_mouseout,false);this.canvasResizer=new i.guiResizer(this,m,this.elems.canvasContainer);this.canvasResizer.events.add("guiResizeStart",this.canvasResizeStart);this.canvasResizer.events.add("guiResizeEnd",this.canvasResizeEnd);var m=this.elems.viewportResizer;if(!m){c.initError(a.missingViewportResizer);return false}m.title=a.guiViewportResizer;m.replaceChild(h.createTextNode(m.title),m.firstChild);m.addEventListener("mouseover",this.item_mouseover,false);m.addEventListener("mouseout",this.item_mouseout,false);this.viewportResizer=new i.guiResizer(this,m,this.elems.viewport);this.viewportResizer.dispatchMouseMove=true;this.viewportResizer.events.add("guiResizeMouseMove",this.viewportResizeMouseMove);this.viewportResizer.events.add("guiResizeEnd",this.viewportResizeEnd);if("statusMessage" in this.elems){this.elems.statusMessage._prevText=false}if("version" in this.elems){this.elems.version.appendChild(h.createTextNode(c.toString()))}var n=this.elems.imageSize;if(n){n.replaceChild(h.createTextNode(c.image.width+"x"+c.image.height),n.firstChild)}c.events.add("canvasSizeChange",this.canvasSizeChange);c.events.add("commandRegister",this.commandRegister);c.events.add("commandUnregister",this.commandUnregister);c.events.add("configChange",this.configChangeHandler);c.events.add("imageSizeChange",this.imageSizeChange);c.events.add("imageZoom",this.imageZoom);c.events.add("appInit",this.appInit);c.events.add("shadowAllow",this.shadowAllow);c.events.add("toolActivate",this.toolActivate);c.events.add("toolRegister",this.toolRegister);c.events.add("toolUnregister",this.toolUnregister);if("historyUndo" in this.commands&&"historyRedo" in this.commands){c.events.add("historyUpdate",this.historyUpdate)}c.commandRegister("about",this.commandAbout);return true};this.initCanvas=function(){var o=this.elems.canvasContainer,k=c.layer.canvas,n=c.layer.context,l=k.style,j=c.buffer.canvas;if(!o){c.initError(a.missingCanvasContainer);return false}var m=o.style;o.className=this.classPrefix+"canvasContainer";k.className=this.classPrefix+"layerCanvas";j.className=this.classPrefix+"bufferCanvas";m.width=l.width;m.height=l.height;if(!b.checkersBackground||i.browser.olpcxo){m.backgroundImage="none"}o.appendChild(k);o.appendChild(j);if("selection_transparent" in this.inputs&&(!n.putImageData||!n.getImageData)){this.inputs.selection_transparent.disabled=true;this.inputs.selection_transparent.checked=true}return true};this.initImportDoc=function(s){var o=b.guiPlaceholder,p=c.ELEMENT_NODE,l,r,j,k,t,q;if(typeof s==="string"){l=h.createElement("div");l.innerHTML=s;r=l.firstChild}else{r=s.documentElement}s=null;j=r.getElementsByTagName("*");k=j.length;for(var m=0;m<k;m++){l=j[m];if(l.nodeType!==p||!l.tagName){continue}t=l.tagName.toLowerCase();q=t==="input"||t==="select"||t==="textarea";if(l.id){l.setAttribute("data-pwId",l.id);if(q){l.id=this.idPrefix+l.id}else{l.removeAttribute("id")}}if(t==="label"&&l.htmlFor){l.htmlFor=this.idPrefix+l.htmlFor}}k=r.childNodes.length;for(var m=0;m<k;m++){o.appendChild(h.importNode(r.childNodes[m],true))}return true};this.initParseMarkup=function(){var m=b.guiPlaceholder.getElementsByTagName("*"),t=c.ELEMENT_NODE,p,v,u,r,s,l,o,n,k,j;for(var q=0;q<m.length;q++){p=m[q];if(p.nodeType!==t){continue}v=p.tagName.toLowerCase();u=v==="input"||v==="select"||v==="textarea";o=p.getAttribute("data-pwCommand");if(o&&!(o in this.commands)){p.className+=" "+this.classPrefix+"command";this.commands[o]=p}r=p.getAttribute("data-pwTool");if(r&&!(r in this.tools)){p.className+=" "+this.classPrefix+"tool";this.tools[r]=p}s=p.getAttribute("data-pwTabPanel");if(s){this.tabPanels[s]=new i.guiTabPanel(this,p)}l=p.getAttribute("data-pwFloatingPanel");if(l){this.floatingPanels[l]=new i.guiFloatingPanel(this,p)}k=p.getAttribute("data-pwConfig");if(k){if(u){this.initConfigInput(p,k)}else{this.initConfigIcons(p,k)}}k=p.getAttribute("data-pwConfigToggle");if(k){this.initConfigToggle(p,k)}if(p.getAttribute("data-pwColorInput")){j=new i.guiColorInput(this,p);this.colorInputs[j.id]=j}n=p.getAttribute("data-pwId");if(n){p.className+=" "+this.classPrefix+n;if(u&&!k){this.inputs[n]=p}else{if(!u){this.elems[n]=p}}}}return true};this.initConfigInput=function(t,j){var u=j.replace(".","_"),o=j.split("."),p=o.pop(),s=o.join("."),r=b,k=a.inputs,q=t.parentNode;for(var m=0,l=o.length;m<l;m++){r=r[o[m]];k=k[o[m]]}t._pwConfigProperty=p;t._pwConfigGroup=s;t._pwConfigGroupRef=r;t.title=k[p+"Title"]||k[p];t.className+=" "+this.classPrefix+"cfg_"+u;this.inputs[u]=t;if(q.tagName.toLowerCase()!=="label"){q=q.getElementsByTagName("label")[0]}if(t.type==="checkbox"||q.htmlFor){q.replaceChild(h.createTextNode(k[p]),q.lastChild)}else{q.replaceChild(h.createTextNode(k[p]),q.firstChild)}if(t.type==="checkbox"){t.checked=r[p]}else{t.value=r[p]}t.addEventListener("input",this.configInputChange,false);t.addEventListener("change",this.configInputChange,false)};this.initConfigIcons=function(x,j){var y=j.replace(".","_"),r=j.split("."),s=r.pop(),w=r.join("."),u=b,k=a.inputs;for(var q=0,m=r.length;q<m;q++){u=u[r[q]];k=k[r[q]]}x._pwConfigProperty=s;x._pwConfigGroup=w;x._pwConfigGroupRef=u;x.title=k[s+"Title"]||k[s];x.className+=" "+this.classPrefix+"cfg_"+y;this.inputs[y]=x;var t=x.getElementsByTagName("p")[0];t.replaceChild(h.createTextNode(k[s]),t.firstChild);var o,p,l,v=" "+this.classPrefix+"configActive";nodes=x.getElementsByTagName("*"),elType=c.ELEMENT_NODE;for(var q=0;q<nodes.length;q++){o=nodes[q];if(o.nodeType!==elType){continue}l=o.getAttribute("data-pwConfigValue");if(!l){continue}p=h.createElement("a");p.href="#";p.title=k[s+"_"+l];p.appendChild(h.createTextNode(p.title));o.className+=" "+this.classPrefix+s+"_"+l+" "+this.classPrefix+"icon";o._pwConfigParent=x;if(u[s]==l){o.className+=v}p.addEventListener("click",this.configValueClick,false);p.addEventListener("mouseover",this.item_mouseover,false);p.addEventListener("mouseout",this.item_mouseout,false);o.replaceChild(p,o.firstChild);this.inputValues[w+"_"+s+"_"+l]=o}};this.initConfigToggle=function(t,j){var u=j.replace(".","_"),p=j.split("."),q=p.pop(),s=p.join("."),r=b,k=a.inputs;for(var o=0,l=p.length;o<l;o++){r=r[p[o]];k=k[p[o]]}t._pwConfigProperty=q;t._pwConfigGroup=s;t._pwConfigGroupRef=r;t.className+=" "+this.classPrefix+"cfg_"+u+" "+this.classPrefix+"icon";if(r[q]){t.className+=" "+this.classPrefix+"configActive"}var m=h.createElement("a");m.href="#";m.title=k[q+"Title"]||k[q];m.appendChild(h.createTextNode(k[q]));m.addEventListener("click",this.configToggleClick,false);m.addEventListener("mouseover",this.item_mouseover,false);m.addEventListener("mouseout",this.item_mouseout,false);t.replaceChild(m,t.firstChild);this.inputs[u]=t};this.initImageZoom=function(){var j=this.inputs.imageZoom;if(!j){return true}j.value=100;j._old_value=100;j.setAttribute("step",b.imageZoomStep*100);j.setAttribute("max",b.imageZoomMax*100);j.setAttribute("min",b.imageZoomMin*100);var l=function(){c.imageZoomTo(parseInt(this.value)/100)};j.addEventListener("change",l,false);j.addEventListener("input",l,false);var k=j.parentNode;if(k.tagName.toLowerCase()==="label"){k.replaceChild(h.createTextNode(a.imageZoomLabel),k.firstChild)}var m=this.elems.statusZoom;if(!m){return true}m.title=a.imageZoomTitle;return true};this.initSelectionTool=function(){var j=" "+this.classPrefix+"disabled",w=this.commands.selectionCut,k=this.commands.selectionCopy,p=this.commands.clipboardPaste;if(p){c.events.add("clipboardUpdate",this.clipboardUpdate);p.className+=j}if(w&&k){c.events.add("selectionChange",this.selectionChange);w.className+=j;k.className+=j}var u=["selectionCut","selectionCopy","clipboardPaste"],t,r,q;for(var s=0,o=u.length;s<o;s++){q=u[s];r=this.elems["selTab_"+q];if(!r){continue}t=h.createElement("a");t.title=a.commands[q];t.href="#";t.appendChild(h.createTextNode(t.title));t.addEventListener("click",this.commandClick,false);r.className+=j+" "+this.classPrefix+"command "+this.classPrefix+"cmd_"+q;r.setAttribute("data-pwCommand",q);r.replaceChild(t,r.firstChild)}var v=this.commands.selectionCrop,l=this.commands.selectionFill,m=this.commands.selectionDelete;v.className+=j;l.className+=j;m.className+=j;return true};this.initTextTool=function(){if("textString" in this.inputs){this.inputs.textString.value=a.inputs.text.textString_value}if(!("text_fontFamily" in this.inputs)||!("text" in b)||!("fontFamilies" in b.text)){return true}var l,j=this.inputs.text_fontFamily;for(var k=0,m=b.text.fontFamilies.length;k<m;k++){l=h.createElement("option");l.value=b.text.fontFamilies[k];l.appendChild(h.createTextNode(l.value));j.appendChild(l);if(l.value===b.text.fontFamily){j.selectedIndex=k;j.value=l.value}}l=h.createElement("option");l.value="+";l.appendChild(h.createTextNode(a.inputs.text.fontFamily_add));j.appendChild(l);return true};this.initKeyboardShortcuts=function(){var j=null,k=null;for(j in b.keys){k=b.keys[j];if("toolActivate" in k&&k.toolActivate in a.tools){a.tools[k.toolActivate]+=" [ "+j+" ]"}if("command" in k&&k.command in a.commands){a.commands[k.command]+=" [ "+j+" ]"}}return true};this.appInit=function(m){if(m.state!==PaintWeb.INIT_DONE){return}if("hand" in g.tools){c.events.add("canvasSizeChange",g.toolHandStateChange);c.events.add("viewportSizeChange",g.toolHandStateChange);g.toolHandStateChange(m)}var n=b.guiPlaceholder,j=n.style;j.height="";j.overflow="";j.position="";j.visibility="";var k=e.getComputedStyle(n,null);if(k.position==="static"){j.position="relative"}try{n.focus()}catch(l){}c.events.dispatch(new f.guiShow())};this.canvasResizeStart=function(){this.resizeHandle.style.visibility="hidden";this.timeout_=setTimeout(function(){g.statusShow("guiCanvasResizerActive",true);clearTimeout(g.canvasResizer.timeout_);delete g.canvasResizer.timeout_},400)};this.canvasResizeEnd=function(j){this.resizeHandle.style.visibility="";c.imageCrop(0,0,d(j.width/c.image.canvasScale),d(j.height/c.image.canvasScale));if(this.timeout_){clearTimeout(this.timeout_);delete this.timeout_}else{g.statusShow(-1)}};this.viewportResizeMouseMove=function(j){b.guiPlaceholder.style.width=j.width+"px"};this.viewportResizeEnd=function(k){g.elems.viewport.style.width="";g.resizeTo(k.width+"px",k.height+"px");try{b.guiPlaceholder.focus()}catch(j){}};this.item_mouseover=function(){if(this.title||this.textConent){g.statusShow(this.title||this.textContent,true)}};this.item_mouseout=function(){g.statusShow(-1)};this.statusShow=function(l,j){var k=this.elems.statusMessage;if(l===-1&&k._prevText===false){return false}if(l===-1){l=k._prevText}if(l in a.status){l=a.status[l]}if(!j){k._prevText=l}if(k.firstChild){k.removeChild(k.firstChild)}e.status=l;if(l){k.appendChild(h.createTextNode(l))}};this.commandAbout=function(){g.floatingPanels.about.toggle()};this.toolClick=function(j){c.toolActivate(this.parentNode.getAttribute("data-pwTool"),j);j.preventDefault()};this.toolActivate=function(u){var r,o=g.tools[u.id],k=g.toolTabConfig[u.id]||{},t=g.tabPanels.main,l=t.tabs.line,q=g.inputs.shapeType,s=g.inputs.line_lineWidth,x=g.inputs.line_lineCap,j=g.inputs.line_lineJoin,p=g.inputs.line_miterLimit,w=null;o.className+=" "+g.classPrefix+"toolActive";try{o.firstChild.focus()}catch(n){}if((u.id+"Active") in a.status){g.statusShow(u.id+"Active")}if(q){if(k.shapeType){q.style.display=""}else{q.style.display="none"}}if(u.prevId){var m=g.tools[u.prevId],v=g.toolTabConfig[u.prevId]||{};m.className=m.className.replace(" "+g.classPrefix+"toolActive","");if(v.lineTab&&l){t.tabHide("line");l.container.className=l.container.className.replace(" "+g.classPrefix+"main_line_"+u.prevId," "+g.classPrefix+"main_line")}if(u.prevId in t.tabs){t.tabHide(u.prevId)}}if(k.lineWidthLabel){w=s.parentNode;w.replaceChild(h.createTextNode(k.lineWidthLabel),w.firstChild)}if(j){if(k.lineJoin){j.style.display=""}else{j.style.display="none"}}if(x){if(k.lineCap){x.style.display=""}else{x.style.display="none"}}if(p){if(k.miterLimit){p.parentNode.parentNode.style.display=""}else{p.parentNode.parentNode.style.display="none"}}if(s){if(k.lineWidth){s.parentNode.parentNode.style.display=""}else{s.parentNode.parentNode.style.display="none"}}if(k.lineTab&&"line" in t.tabs){r=l.button.firstChild;r.title=k.lineTabLabel||a.tabs.main[u.id];r.replaceChild(h.createTextNode(r.title),r.firstChild);if(u.id!=="line"){l.container.className=l.container.className.replace(" "+g.classPrefix+"main_line"," "+g.classPrefix+"main_line_"+u.id)}t.tabShow("line")}if(u.id in t.tabs){t.tabShow(u.id)}};this.toolRegister=function(m){var j=null,l=null,k=null;if(m.id in g.tools){l=g.tools[m.id];j=l.getAttribute("data-pwTool");if(j&&j!==m.id){j=null;l=null;delete g.tools[m.id]}}if(!l){l=h.createElement("li")}if(!j){l.setAttribute("data-pwTool",m.id)}l.className+=" "+g.classPrefix+"tool_"+m.id;k=h.createElement("a");k.title=a.tools[m.id];k.href="#";k.appendChild(h.createTextNode(k.title));if(l.firstChild){l.replaceChild(k,l.firstChild)}else{l.appendChild(k)}k.addEventListener("click",g.toolClick,false);k.addEventListener("mouseover",g.item_mouseover,false);k.addEventListener("mouseout",g.item_mouseout,false);if(!(m.id in g.tools)){g.tools[m.id]=l;g.elems.tools.appendChild(l)}if(m.id==="text"&&!c.layer.context.fillText&&!c.layer.context.mozPathText&&l){l.className+=" "+g.classPrefix+"disabled";k.title=a.tools.textUnsupported;k.removeEventListener("click",g.toolClick,false);k.addEventListener("click",function(n){n.preventDefault()},false)}};this.toolUnregister=function(j){if(j.id in g.tools){g.elems.tools.removeChild(g.tools[j.id]);delete g.tools[j.id]}else{return}};this.commandClick=function(k){var l=this.parentNode.getAttribute("data-pwCommand");if(l&&l in c.commands){c.commands[l].call(this,k)}k.preventDefault();try{this.focus()}catch(j){}};this.commandRegister=function(l){var k=g.commands[l.id],j=null;if(!k){return}k.className+=" "+g.classPrefix+"cmd_"+l.id;j=h.createElement("a");j.title=a.commands[l.id];j.href="#";j.appendChild(h.createTextNode(j.title));if(k.firstChild){k.removeChild(k.firstChild)}k.appendChild(j);j.addEventListener("click",g.commandClick,false);j.addEventListener("mouseover",g.item_mouseover,false);j.addEventListener("mouseout",g.item_mouseout,false)};this.commandUnregister=function(l){var k=g.commands[l.id],j=null;if(!k){return}k.className=k.className.replace(" "+g.classPrefix+"cmd_"+l.id,"");j=k.firstChild;j.removeEventListener("click",this.commands[l.id],false);j.removeEventListener("mouseover",g.item_mouseover,false);j.removeEventListener("mouseout",g.item_mouseout,false);k.removeChild(j)};this.historyUpdate=function(n){var j=g.commands.historyUndo,q=false,p=g.commands.historyRedo,k=false,m=" "+g.classPrefix+"disabled",o=j.className.indexOf(m)===-1,l=p.className.indexOf(m)===-1;if(n.currentPos>1){q=true}if(n.currentPos<n.states){k=true}if(o!==q){if(q){j.className=j.className.replace(m,"")}else{j.className+=m}}if(l!==k){if(k){p.className=p.className.replace(m,"")}else{p.className+=m}}};this.imageSizeChange=function(j){var k=g.elems.imageSize;if(k){k.replaceChild(h.createTextNode(j.width+"x"+j.height),k.firstChild)}};this.canvasSizeChange=function(l){var n=g.elems.canvasContainer,m=g.canvasResizer,j=" "+g.classPrefix+"disabled",k=m.resizeHandle;n.style.width=l.width+"px";n.style.height=l.height+"px";k.style.top=l.height+"px";k.style.left=l.width+"px"};this.imageZoom=function(k){var j=g.inputs.imageZoom,l=d(k.zoom*100);if(j&&j.value!=l){j.value=l}};this.configChangeHandler=function(q){var m="",r;if(q.group){m=q.group.replace(".","_")+"_"}m+=q.config;r=g.inputs[m];if(!r&&(r=g.colorInputs[m])){var k=q.value.replace(/\s+/g,"").replace(/^rgba\(/,"").replace(/\)$/,"");k=k.split(",");r.updateColor({red:k[0]/255,green:k[1]/255,blue:k[2]/255,alpha:k[3]});return}if(!r){return}var s=r.tagName.toLowerCase(),p=s==="select"||s==="input"||s==="textarea";if(p){if(r.type==="checkbox"&&r.checked!==q.value){r.checked=q.value}if(r.type!=="checkbox"&&r.value!==q.value){r.value=q.value}return}var n=" "+g.className+"configActive";if(r.hasAttribute("data-pwConfigToggle")){var l=r.className.indexOf(n)!==-1;if(q.value&&!l){r.className+=n}else{if(!q.value&&l){r.className=r.className.replace(n,"")}}}var n=" "+g.className+"configActive",o=g.inputValues[m+"_"+q.previousValue],j=g.inputValues[m+"_"+q.value];if(o&&o.className.indexOf(n)!==-1){o.className=o.className.replace(n,"")}if(j&&j.className.indexOf(n)===-1){j.className+=n}};this.configValueClick=function(p){var s=this.parentNode,q=s._pwConfigParent,k=s.getAttribute("data-pwConfigValue");if(!q||!q._pwConfigProperty){return}p.preventDefault();var o=" "+g.classPrefix+"configActive",m=q._pwConfigGroupRef,r=q._pwConfigGroup,j=q._pwConfigProperty,l=m[j],n=g.inputValues[r.replace(".","_")+"_"+j+"_"+l];if(l==k){return}if(n&&n.className.indexOf(o)!==-1){n.className=n.className.replace(o,"")}m[j]=k;if(s.className.indexOf(o)===-1){s.className+=o}c.events.dispatch(new f.configChange(k,l,j,r,m))};this.configInputChange=function(){if(!this._pwConfigProperty){return}var l=this.type==="checkbox"?this.checked:this.value,j=this._pwConfigGroupRef,k=this._pwConfigGroup,n=this._pwConfigProperty,m=j[n];if(this.getAttribute("type")==="number"){l=parseInt(l);if(l!=this.value){this.value=l}}if(l==m){return}j[n]=l;c.events.dispatch(new f.configChange(l,m,n,k,j))};this.configToggleClick=function(m){var l=" "+g.classPrefix+"configActive",k=this.parentNode,j=k._pwConfigGroupRef,n=k._pwConfigGroup,p=k._pwConfigProperty,o=k.className.indexOf(l)!==-1;m.preventDefault();j[p]=!j[p];if(j[p]&&!o){k.className+=l}else{if(!j[p]&&o){k.className=k.className.replace(l,"")}}c.events.dispatch(new f.configChange(j[p],!j[p],p,n,j))};this.shadowAllow=function(j){if("shadow" in g.tabPanels.main.tabs){if(j.allowed){g.tabPanels.main.tabShow("shadow")}else{g.tabPanels.main.tabHide("shadow")}}};this.clipboardUpdate=function(o){var k=" "+g.classPrefix+"disabled",m,p,j=[g.commands.clipboardPaste,g.elems.selTab_clipboardPaste];for(var l=0,q=j.length;l<q;l++){m=j[l];if(!m){continue}p=m.className.indexOf(k)===-1;if(!o.data&&p){m.className+=k}else{if(o.data&&!p){m.className=m.className.replace(k,"")}}}};this.selectionChange=function(o){var k=" "+g.classPrefix+"disabled",m,p,j=[g.commands.selectionCut,g.commands.selectionCopy,g.elems.selTab_selectionCut,g.elems.selTab_selectionCopy,g.commands.selectionDelete,g.commands.selectionFill,g.commands.selectionCrop];for(var l=0,q=j.length;l<q;l++){m=j[l];if(!m){continue}p=m.className.indexOf(k)===-1;if(o.state===o.STATE_NONE&&p){m.className+=k}else{if(o.state===o.STATE_SELECTED&&!p){m.className=m.className.replace(k,"")}}}};this.show=function(){var m=b.guiPlaceholder,k=this.classPrefix+"placeholder",j=new RegExp("\\b"+k);if(!j.test(m.className)){m.className+=" "+k}try{m.focus()}catch(l){}c.events.dispatch(new f.guiShow())};this.hide=function(){var k=b.guiPlaceholder,j=new RegExp("\\b"+this.classPrefix+"placeholder","g");k.className=k.className.replace(j,"");c.events.dispatch(new f.guiHide())};this.destroy=function(){var j=b.guiPlaceholder;while(j.hasChildNodes()){j.removeChild(j.firstChild)}};this.resizeTo=function(m,j){if(!m||!j){return}var k=b.viewportWidth,l=b.viewportHeight;b.viewportWidth=m;b.viewportHeight=j;c.events.dispatch(new f.configChange(m,k,"viewportWidth","",b));c.events.dispatch(new f.configChange(j,l,"viewportHeight","",b));b.guiPlaceholder.style.width=b.viewportWidth;this.elems.viewport.style.height=b.viewportHeight;c.events.dispatch(new f.viewportSizeChange(m,j))};this.toolHandStateChange=function(q){var l=0,n=0,o=" "+g.classPrefix+"disabled",k=g.tools.hand,m=g.elems.viewport;if(!k){return}if(q.type==="canvasSizeChange"){l=q.width;n=q.height}else{var p=g.elems.canvasContainer.style;l=parseInt(p.width);n=parseInt(p.height)}cs=e.getComputedStyle(m,null);var j=parseInt(cs.width),t=parseInt(cs.height),r=false,s=k.className.indexOf(o)===-1;if(t<n||j<l){r=true}if(r&&!s){k.className=k.className.replace(o,"")}else{if(!r&&s){k.className+=o}}if(!r&&c.tool&&c.tool._id==="hand"&&"prevTool" in c.tool){c.toolActivate(c.tool.prevTool,q)}}};pwlib.guiFloatingPanel=function(q,n){var g=this,v=pwlib.appEvent,c=n.style,x=q.app.doc,t=q.app.config.guiPlaceholder,y=q.app.lang,e=q.floatingPanels,j=q.app.win,d=200;var p,o;var k,l;this.STATE_HIDDEN=0;this.STATE_VISIBLE=1;this.STATE_MINIMIZED=3;this.STATE_DRAGGING=4;this.state=-1;this.id=null;this.container=n;this.viewport=null;this.events=null;this.content=null;var h=0,w=0,r=null,m=null;function s(){g.events=new pwlib.appEvents(g);g.id=g.container.getAttribute("data-pwFloatingPanel");var z=g.container.getElementsByTagName("h1")[0],D=g.container.getElementsByTagName("div")[0],B=j.getComputedStyle(g.container,null),F=parseInt(B.zIndex);c.zIndex=B.zIndex;if(F>e.zIndex_){e.zIndex_=F}g.container.className+=" "+q.classPrefix+"floatingPanel "+q.classPrefix+"floatingPanel_"+g.id;D.className+=" "+q.classPrefix+"floatingPanel_content";g.content=D;z.className+=" "+q.classPrefix+"floatingPanel_title";z.replaceChild(x.createTextNode(y.floatingPanels[g.id]),z.firstChild);z.addEventListener("mousedown",a,false);if(g.container.getAttribute("data-pwPanelHide")==="true"){g.hide()}else{g.state=g.STATE_VISIBLE}var A=g.container.parentNode,E=null;while(!E&&A){if(A.nodeName.toLowerCase()==="html"){E=A;break}B=j.getComputedStyle(A,null);if(B&&(B.overflow==="scroll"||B.overflow==="auto")){E=A}else{A=A.parentNode}}g.viewport=E;m=x.createElement("a");m.href="#";m.title=y.floatingPanelMinimize;m.className=q.classPrefix+"floatingPanel_minimize";m.addEventListener("click",b,false);m.appendChild(x.createTextNode(m.title));g.container.insertBefore(m,D);r=x.createElement("a");r.href="#";r.title=y.floatingPanelClose;r.className=q.classPrefix+"floatingPanel_close";r.addEventListener("click",u,false);r.appendChild(x.createTextNode(r.title));g.container.insertBefore(r,D);if(g.container.getAttribute("data-pwPanelResizable")==="true"){var C=x.createElement("div");C.className=q.classPrefix+"floatingPanel_resizer";g.container.appendChild(C);g.resizer=new pwlib.guiResizer(q,C,g.container)}}function b(A){A.preventDefault();try{this.focus()}catch(z){}var B=" "+q.classPrefix+"floatingPanel_minimized";if(g.state===g.STATE_MINIMIZED){g.state=g.STATE_VISIBLE;this.title=y.floatingPanelMinimize;this.className=q.classPrefix+"floatingPanel_minimize";this.replaceChild(x.createTextNode(this.title),this.firstChild);if(g.container.className.indexOf(B)!==-1){g.container.className=g.container.className.replace(B,"")}}else{if(g.state===g.STATE_VISIBLE){g.state=g.STATE_MINIMIZED;this.title=y.floatingPanelRestore;this.className=q.classPrefix+"floatingPanel_restore";this.replaceChild(x.createTextNode(this.title),this.firstChild);if(g.container.className.indexOf(B)===-1){g.container.className+=B}}}g.events.dispatch(new v.guiFloatingPanelStateChange(g.state));g.bringOnTop()}function u(A){A.preventDefault();g.hide();try{t.focus()}catch(z){}}function a(A){g.state=g.STATE_DRAGGING;p=A.clientX;o=A.clientY;var z=j.getComputedStyle(g.container,null);k=parseInt(z.top);l=parseInt(z.left);if(g.viewport){h=g.viewport.scrollLeft;w=g.viewport.scrollTop}g.bringOnTop();x.addEventListener("mousemove",i,false);x.addEventListener("mouseup",f,false);g.events.dispatch(new v.guiFloatingPanelStateChange(g.state));if(A.preventDefault){A.preventDefault()}}function i(A){var z=l+A.clientX-p,B=k+A.clientY-o;if(g.viewport){if(g.viewport.scrollLeft!==h){z+=g.viewport.scrollLeft-h}if(g.viewport.scrollTop!==w){B+=g.viewport.scrollTop-w}}c.left=z+"px";c.top=B+"px"}function f(A){if(g.container.className.indexOf(" "+q.classPrefix+"floatingPanel_minimized")!==-1){g.state=g.STATE_MINIMIZED}else{g.state=g.STATE_VISIBLE}x.removeEventListener("mousemove",i,false);x.removeEventListener("mouseup",f,false);try{t.focus()}catch(z){}g.events.dispatch(new v.guiFloatingPanelStateChange(g.state))}this.bringOnTop=function(){e.zIndex_+=d;c.zIndex=e.zIndex_};this.hide=function(){c.display="none";g.state=g.STATE_HIDDEN;g.events.dispatch(new v.guiFloatingPanelStateChange(g.state))};this.show=function(){if(g.state===g.STATE_VISIBLE){return}c.display="block";g.state=g.STATE_VISIBLE;var z=" "+q.classPrefix+"floatingPanel_minimized";if(g.container.className.indexOf(z)!==-1){g.container.className=g.container.className.replace(z,"");m.className=q.classPrefix+"floatingPanel_minimize";m.title=y.floatingPanelMinimize;m.replaceChild(x.createTextNode(m.title),m.firstChild)}g.events.dispatch(new v.guiFloatingPanelStateChange(g.state));g.bringOnTop()};this.toggle=function(){if(g.state===g.STATE_VISIBLE||g.state===g.STATE_MINIMIZED){g.hide()}else{g.show()}};s()};pwlib.appEvent.guiFloatingPanelStateChange=function(a){this.STATE_HIDDEN=0;this.STATE_VISIBLE=1;this.STATE_MINIMIZED=3;this.STATE_DRAGGING=4;this.state=a;pwlib.appEvent.call(this,"guiFloatingPanelStateChange")};pwlib.guiResizer=function(p,k,l){var g=this,c=l.style,s=p.app.doc,e=pwlib.appEvent.guiResizeEnd,b=pwlib.appEvent.guiResizeMouseMove,m=pwlib.appEvent.guiResizeStart,j=p.app.win;this.events=null;this.resizeHandle=k;this.container=l;this.viewport=null;this.dispatchMouseMove=false;this.resizing=false;var o=0,n=0;var t=0,d=0;var h=0,r=0;function q(){g.events=new pwlib.appEvents(g);k.addEventListener("mousedown",a,false);var v,u=g.container.parentNode,w=null;while(!w&&u){if(u.nodeName.toLowerCase()==="html"){w=u;break}v=j.getComputedStyle(u,null);if(v&&(v.overflow==="scroll"||v.overflow==="auto")){w=u}else{u=u.parentNode}}g.viewport=w}function a(w){o=w.clientX;n=w.clientY;var u=j.getComputedStyle(g.container,null);t=parseInt(u.width);d=parseInt(u.height);var v=g.events.dispatch(new m(o,n,t,d));if(v){return}if(g.viewport){h=g.viewport.scrollLeft;r=g.viewport.scrollTop}g.resizing=true;s.addEventListener("mousemove",i,false);s.addEventListener("mouseup",f,false);if(w.preventDefault){w.preventDefault()}if(w.stopPropagation){w.stopPropagation()}}function i(x){var u=t+x.clientX-o,v=d+x.clientY-n;if(g.viewport){if(g.viewport.scrollLeft!==h){u+=g.viewport.scrollLeft-h}if(g.viewport.scrollTop!==r){v+=g.viewport.scrollTop-r}}c.width=u+"px";c.height=v+"px";if(g.dispatchMouseMove){g.events.dispatch(new b(x.clientX,x.clientY,u,v))}}function f(v){var u=g.events.dispatch(new e(v.clientX,v.clientY,parseInt(c.width),parseInt(c.height)));if(u){return}g.resizing=false;s.removeEventListener("mousemove",i,false);s.removeEventListener("mouseup",f,false)}q()};pwlib.appEvent.guiResizeStart=function(b,d,c,a){this.x=b;this.y=d;this.width=c;this.height=a;pwlib.appEvent.call(this,"guiResizeStart",true)};pwlib.appEvent.guiResizeEnd=function(b,d,c,a){this.x=b;this.y=d;this.width=c;this.height=a;pwlib.appEvent.call(this,"guiResizeEnd",true)};pwlib.appEvent.guiResizeMouseMove=function(b,d,c,a){this.x=b;this.y=d;this.width=c;this.height=a;pwlib.appEvent.call(this,"guiResizeMouseMove")};pwlib.guiTabPanel=function(b,a){var e=this,d=pwlib.appEvent,g=b.app.doc,c=b.app.lang;this.events=null;this.id=null;this.tabs={};this.tabButtons=null;this.container=a;this.tabId=null;var h=null;function i(){e.events=new pwlib.appEvents(e);e.id=e.container.getAttribute("data-pwTabPanel");e.container.className+=" "+b.classPrefix+"tabPanel "+b.classPrefix+"tabPanel_"+e.id;var l=g.createElement("ul"),p=null,o=e.container.getAttribute("data-pwTabDefault")||null,r=e.container.childNodes,q=b.app.ELEMENT_NODE,k=null,j=null,n=null;l.className=b.classPrefix+"tabsList";for(var m=0;k=r[m];m++){if(k.nodeType!==q){continue}j=k.getAttribute("data-pwTab");if(!j){continue}k.className+=" "+b.classPrefix+"tab "+b.classPrefix+e.id+"_"+j;p=g.createElement("li");p._pwTab=j;n=g.createElement("a");n.href="#";n.addEventListener("click",f,false);if(e.id in c.tabs){n.title=c.tabs[e.id][j+"Title"]||c.tabs[e.id][j];n.appendChild(g.createTextNode(c.tabs[e.id][j]))}if((o&&j===o)||(!o&&!e.tabId)){e.tabId=j;p.className=b.classPrefix+"tabActive"}else{h=j;k.style.display="none"}if(k.getAttribute("data-pwTabHide")==="true"){p.style.display="none"}e.tabs[j]={container:k,button:p};p.appendChild(n);l.appendChild(p)}e.tabButtons=l;e.container.appendChild(l)}function f(j){j.preventDefault();e.tabActivate(this.parentNode._pwTab)}this.tabActivate=function(j){if(!j||!(j in this.tabs)){return false}else{if(j===this.tabId){return true}}var n=new d.guiTabActivate(j,this.tabId),m=this.events.dispatch(n),l=null,o=null;if(m){return false}if(this.tabId in this.tabs){l=this.tabs[this.tabId].container;l.style.display="none";o=this.tabs[this.tabId].button;o.className="";h=this.tabId}l=this.tabs[j].container;l.style.display="";o=this.tabs[j].button;o.className=b.classPrefix+"tabActive";o.style.display="";this.tabId=j;try{o.firstChild.focus()}catch(k){}return true};this.tabHide=function(j){if(!(j in this.tabs)){return false}if(this.tabId===j){this.tabActivate(h)}this.tabs[j].button.style.display="none";return true};this.tabShow=function(j){if(!(j in this.tabs)){return false}this.tabs[j].button.style.display="";return true};i()};pwlib.appEvent.guiTabActivate=function(a,b){this.tabId=a;this.prevTabId=b;pwlib.appEvent.call(this,"guiTabActivate",true)};pwlib.guiColorInput=function(a,j){var i=this,g=null,c=a.app.config,k=a.app.doc,f=Math.round,b=a.app.lang;this.id=null;this.input=j;this.configProperty=null;this.configGroup=null;this.configGroupRef=null;this.color={red:0,green:0,blue:0,alpha:0};function l(){var m=i.input.getAttribute("data-pwColorInput"),y=m.replace(".","_"),t=m.split("."),u=t.pop(),x=t.join("."),v=c,o=b.inputs,w=i.input.parentNode,s=k.createElement("a"),q;for(var r=0,p=t.length;r<p;r++){v=v[t[r]];o=o[t[r]]}i.configProperty=u;i.configGroup=x;i.configGroupRef=v;i.id=y;i.input.className+=" "+a.classPrefix+"colorInput "+a.classPrefix+i.id;w.replaceChild(k.createTextNode(o[u]),w.firstChild);q=i.configGroupRef[i.configProperty];q=q.replace(/\s+/g,"").replace(/^rgba\(/,"").replace(/\)$/,"");q=q.split(",");i.color.red=q[0]/255;i.color.green=q[1]/255;i.color.blue=q[2]/255;i.color.alpha=q[3];s.style.backgroundColor="rgb("+q[0]+","+q[1]+","+q[2]+")";s.style.opacity=q[3];s.href="#";s.title=o[u+"Title"]||o[u];s.appendChild(k.createTextNode(b.inputs.colorInputAnchorContent));s.addEventListener("click",d,false);i.input.replaceChild(s,i.input.firstChild)}function d(m){m.preventDefault();if(!g){g=a.app.extensions.colormixer}if(!g.targetInput||g.targetInput.id!==i.id){g.show({id:i.id,configProperty:i.configProperty,configGroup:i.configGroup,configGroupRef:i.configGroupRef,show:h,hide:e},i.color)}else{g.hide()}}function h(){var m=" "+a.classPrefix+"colorInputActive",n=i.input.className.indexOf(m)!==-1;if(!n){i.input.className+=m}}function e(){var m=" "+a.classPrefix+"colorInputActive",n=i.input.className.indexOf(m)!==-1;if(n){i.input.className=i.input.className.replace(m,"")}}this.updateColor=function(m){var n=i.input.firstChild.style;n.opacity=m.alpha;n.backgroundColor="rgb("+f(m.red*255)+","+f(m.green*255)+","+f(m.blue*255)+")";i.color.red=m.red;i.color.green=m.green;i.color.blue=m.blue;i.color.alpha=m.alpha};l()};pwlib.fileCache["interfaces/default/layout.xhtml"]='<div xmlns="http://www.w3.org/1999/xhtml">  <h1 class="paintweb_appTitle">PaintWeb</h1>  <div data-pwTabPanel="main" data-pwTabDefault="main">  <div data-pwTab="main">  <ul id="tools">  <li data-pwCommand="historyUndo">Undo</li>  <li data-pwCommand="historyRedo">Redo</li>  <li class="paintweb_toolSeparator">&#160;</li>  <li data-pwCommand="imageClear">Clear image</li>  <!--<li data-pwCommand="imageSave">Save image</li>-->  <li data-pwTool="insertimg">Insert image</li>  <li class="paintweb_toolSeparator">&#160;</li>  <li data-pwCommand="selectionCut">Cut selection</li>  <li data-pwCommand="selectionCopy">Copy selection</li>  <li data-pwCommand="clipboardPaste">Clipboard paste</li>  <li class="paintweb_toolSeparator">&#160;</li>  <li data-pwTool="cpicker">Color picker</li>  <li data-pwTool="cbucket">Color bucket</li>  <li class="paintweb_toolsWrap">&#160;</li>  <li data-pwTool="selection">Selection</li>  <li data-pwTool="hand">Hand</li>  <li class="paintweb_toolSeparator">&#160;</li>  <li data-pwTool="rectangle">Rectangle</li>  <li data-pwTool="ellipse">Ellipse</li>  <li data-pwTool="polygon">Polygon</li>  <li data-pwTool="line">Line</li>  <li data-pwTool="bcurve">B\u00e9zier curve</li>  <li data-pwTool="text">Text</li>  <li data-pwTool="pencil">Pencil</li>  <li class="paintweb_toolSeparator">&#160;</li>  <li data-pwTool="eraser">Eraser</li>  <li class="paintweb_toolSeparator">&#160;</li>  </ul>  <div class="paintweb_strokeFillStyles">  <p class="paintweb_opt_fillStyle">Fill <span   data-pwColorInput="fillStyle">&#160;</span>  </p>  <p class="paintweb_opt_strokeStyle">Stroke <span   data-pwColorInput="strokeStyle">&#160;</span>  </p>  </div>  <div class="paintweb_strokeFillStyles search-button-img">  <span data-pwCommand="imageSave"></span>  </div>  </div>  <div data-pwTab="line" data-pwTabHide="true">  <p class="paintweb_opt_lineWidth"><label>Line width <input   data-pwConfig="line.lineWidth" type="number" min="1" value="1"   /></label></p>  <p class="paintweb_opt_miterLimit"><label>Miter limit <input    data-pwConfig="line.miterLimit" type="number" min="1" value="10"   /></label></p>  <div data-pwConfig="line.lineCap">  <p>Line cap</p>  <div data-pwConfigValue="butt">Butt</div>  <div data-pwConfigValue="square">Square</div>  <div data-pwConfigValue="round">Round</div>  </div>  <div data-pwConfig="line.lineJoin">  <p>Line join</p>  <div data-pwConfigValue="miter">Miter</div>  <div data-pwConfigValue="round">Round</div>  <div data-pwConfigValue="bevel">Bevel</div>  </div>  <div data-pwConfig="shapeType">  <p>Shape type</p>  <div data-pwConfigValue="both">Both</div>  <div data-pwConfigValue="fill">Fill</div>  <div data-pwConfigValue="stroke">Stroke</div>  </div>  </div>  <div data-pwTab="selection" data-pwTabHide="true">  <p data-pwId="selTab_selectionCut">Cut selection</p>  <p data-pwId="selTab_selectionCopy">Copy selection</p>  <p data-pwId="selTab_clipboardPaste">Clipboard paste</p>  <p data-pwCommand="selectionCrop">Crop selection</p>  <p data-pwCommand="selectionDelete">Delete selection</p>  <p data-pwCommand="selectionFill">Fill selection</p>  <p class="paintweb_opt_selectionTransparent">  <label><input data-pwConfig="selection.transparent" type="checkbox"   value="1" checked="checked" /> Transparent background</label>  </p>  <p class="paintweb_opt_selectionTransform">  <label><input data-pwConfig="selection.transform" type="checkbox"   value="1" /> Transformation mode</label>  </p>  </div>  <div data-pwTab="text" data-pwTabHide="true">  <p class="paintweb_opt_fontFamily">  <label for="fontFamily">Font family:</label>  <select id="fontFamily" data-pwConfig="text.fontFamily"></select>  </p>  <p class="paintweb_opt_fontSize">  <label for="fontSize">Font size:</label>  <input id="fontSize" data-pwConfig="text.fontSize" type="number" min="6"   value="12" />  </p>  <div data-pwConfigToggle="text.bold">Bold</div>  <div data-pwConfigToggle="text.italic">Italic</div>  <div data-pwConfig="text.textAlign">  <p>Text alignment</p>  <div data-pwConfigValue="left">Left</div>  <div data-pwConfigValue="center">Center</div>  <div data-pwConfigValue="right">Right</div>  </div>  <p class="paintweb_opt_textString">  <label>String <textarea id="textString" rows="2" cols="4">Hello   world!</textarea></label>  </p>  </div>  <div data-pwTab="shadow">  <p class="paintweb_opt_shadowEnable"><label><input   data-pwConfig="shadow.enable" type="checkbox" value="1" /> Draw   shadows</label></p>  <p class="paintweb_opt_shadowColor">Color <span   data-pwColorInput="shadow.shadowColor">&#160;</span>  </p>  <p class="paintweb_opt_shadowOffsetX">  <label>Offset X  <input data-pwConfig="shadow.shadowOffsetX" type="number" value="5" />  </label>  </p>  <p class="paintweb_opt_shadowOffsetY">  <label>Offset Y  <input data-pwConfig="shadow.shadowOffsetY" type="number" value="5" />  </label>  </p>  <p class="paintweb_opt_shadowBlur">  <label>Blur  <input data-pwConfig="shadow.shadowBlur" type="number" value="5"   min="0" />  </label>  </p>  </div>  <p data-pwCommand="about">About</p>  </div>   <div id="viewport">  <div id="canvasContainer">  </div>  <div id="canvasResizer">Resize the image Canvas.</div>  </div>   <div class="paintweb_statusbar">  <p id="imageSize">WxH</p>  <p id="statusZoom" title="Zoom image">  <label>Zoom: <input id="imageZoom" type="number" min="20" max="400"   value="100" step="10" /></label>  </p>  <p id="statusMessage">Status</p>  <p id="viewportResizer">Resize the image viewport.</p>  </div>   <div data-pwFloatingPanel="colormixer" data-pwPanelHide="true">  <h1>Color mixer</h1>  <div>  <ol class="paintweb_colormixer_preview">  <li id="colormixer_colorActive"><span>&#160;</span> Active</li>  <li id="colormixer_colorOld"><span>&#160;</span> Old</li>  </ol>  <ol class="paintweb_colormixer_actions">  <li id="colormixer_btn_accept">Close</li>  <li id="colormixer_btn_cancel">Cancel</li>  <li id="colormixer_btn_saveColor">Save color</li>  <li id="colormixer_btn_pickColor">Pick color</li>  </ol>  <div data-pwTabPanel="colormixer_selector" data-pwTabDefault="mixer">  <div data-pwTab="mixer">  <canvas id="colormixer_canvas" width="200" height="195">Your browser   does not support Canvas.</canvas>  <div id="colormixer_controls">  <span id="colormixer_chartDot"></span>  <span id="colormixer_slider"></span>  </div>  </div>  <div data-pwTab="cpalettes">  <select id="colormixer_cpaletteInput"></select>  <div id="colormixer_cpaletteOutput"></div>  </div>  </div>  <ol class="paintweb_colormixer_hexalpha">  <li><label>HEX  <input id="ckey_hex" value="#RRGGBB" type="text" maxlength="7"   pattern="#[a-f0-9]{6}" /></label>  </li>  <li><label>Alpha  <input id="ckey_alpha" value="100" type="number" min="0" max="100"   step="1" /></label>  </li>  </ol>  <form data-pwTabPanel="colormixer_inputs" data-pwTabDefault="rgb">  <ol data-pwTab="rgb">  <li>  <input name="ckey" value="red" type="radio" />  <label>Red  <input name="ckey_red" value="0" type="number" min="0" max="255"   step="1" /></label>  </li>  <li>  <input name="ckey" value="green" type="radio" />  <label>Green  <input name="ckey_green" value="0" type="number" min="0" max="255"   step="1" /></label>  </li>  <li>  <input name="ckey" value="blue" type="radio" />  <label>Blue  <input name="ckey_blue" value="0" type="number" min="0" max="255"   step="1" /></label>  </li>  </ol>  <ol data-pwTab="hsv">  <li>  <input name="ckey" value="hue" type="radio" />  <label>Hue  <input name="ckey_hue" value="0" type="number" min="0" max="360"   step="1" /></label>  </li>  <li>  <input name="ckey" value="sat" type="radio" />  <label>Saturation  <input name="ckey_sat" value="0" type="number" min="0" max="255"   step="1" /></label>  </li>  <li>  <input name="ckey" value="val" type="radio" />  <label>Value  <input name="ckey_val" value="0" type="number" min="0" max="255"   step="1" /></label>  </li>  </ol>  <ol data-pwTab="lab">  <li>  <input name="ckey" value="cie_l" type="radio" />  <label>Lightness  <input name="ckey_cie_l" value="0" type="number" min="0"      max="100" step="1" /></label>  </li>  <li>  <input name="ckey" value="cie_a" type="radio" />  <label>a*  <input name="ckey_cie_a" value="0" type="number" min="-85"    max="94" step="1" /></label>  </li>  <li>  <input name="ckey" value="cie_b" type="radio" />  <label>b*  <input name="ckey_cie_b" value="0" type="number" min="-109"   max="95" step="1" /></label>  </li>  </ol>  <ol data-pwTab="cmyk">  <li>  <label>Cyan  <input name="ckey_cyan" value="0" type="number" min="0" max="100"   step="1" /></label>  </li>  <li>  <label>Magenta  <input name="ckey_magenta" value="0" type="number" min="0"   max="100" step="1" /></label>  </li>  <li>  <label>Yellow  <input name="ckey_yellow" value="0" type="number" min="0" max="100"   step="1" /></label>  </li>  <li>  <label>Key (Black)  <input name="ckey_black" value="0" type="number" min="0" max="100"   step="1" /></label>  </li>  </ol>  </form>   </div>   </div>   <div data-pwFloatingPanel="about" data-pwPanelHide="true">  <h1>About</h1>  <div>  <ul>  <li id="version"><strong>Version:</strong> </li>  <li><strong>Authors:</strong> <a href="http://www.robodesign.ro">Marius   and Mihai \u015eucan (ROBO Design)</a></li>  <li><strong>Project site:</strong> <a   href="http://code.google.com/p/paintweb">code.google.com/p/paintweb</a></li>  <li><strong>Code license:</strong> <a   href="http://www.gnu.org/licenses/gpl-3.0.html" title="GNU General   Public License, version 3">GPLv3</a></li>  </ul>  <p>For user and developer documentation please check out the <a   href="http://code.google.com/p/paintweb">project site</a>.</p>  </div>  </div>  </div>';function PaintWeb(win,doc){var _self=this;if(!win){win=window}if(!doc){doc=document}this.version=0.9;this.build=20111103;this.config={showErrors:true};this.lang={noComputedStyle:"Error: window.getComputedStyle is not available.",noXMLHttpRequest:"Error: window.XMLHttpRequest is not available.",noCanvasSupport:"Error: Your browser does not support Canvas.",guiPlaceholderWrong:"Error: The config.guiPlaceholder property must reference a DOM element!",initHandlerMustBeFunction:"The first argument must be a function.",noConfigFile:"Error: You must point to a configuration file by setting the config.configFile property!",failedConfigLoad:"Error: Failed loading the configuration file.",failedLangLoad:"Error: Failed loading the language file."};this.buffer={canvas:null,context:null};this.layer={id:null,canvas:null,context:null};this.tool=null;this.elems={};this.mouse={x:0,y:0,buttonDown:false};this.extensions={};this.commands={};this.gui=null;this.doc=doc;this.win=win;this.image={width:0,height:0,zoom:1,canvasScale:1,modified:false};this.resolution={elem:null,elemId:"paintweb_resInfo",cssText:"@media screen and (resolution:96dpi){#paintweb_resInfo{width:96px}}@media screen and (resolution:134dpi){#paintweb_resInfo{width:134px}}@media screen and (resolution:200dpi){#paintweb_resInfo{width:200px}}@media screen and (resolution:300dpi){#paintweb_resInfo{width:300px}}#paintweb_resInfo{display:block;height:100%;left:-3000px;position:fixed;top:0;visibility:hidden;z-index:-32}",dpiOptimal:96,dpiLocal:96,browserZoom:1,scale:-1};this.history={pos:0,states:[]};this.shadowSupported=true;this.shadowAllowed=true;this.clipboard=false;this.initialized=PaintWeb.INIT_NOT_STARTED;this.events=null;this.UID=0;this.stateProperties=["strokeStyle","fillStyle","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","globalCompositeOperation","font","textAlign","textBaseline"];var kbListener_=null;var temp_={onInit:null,toolsLoadQueue:0,extensionsLoadQueue:0};var MathAbs=Math.abs,MathFloor=Math.floor,MathMax=Math.max,MathMin=Math.min,MathRound=Math.round,pwlib=null,appEvent=null,lang=this.lang;this.ELEMENT_NODE=window.Node?Node.ELEMENT_NODE:1;function preInit(){var d=new Date();if(_self.build===-1){var dateArr=[d.getFullYear(),d.getMonth()+1,d.getDate()];if(dateArr[1]<10){dateArr[1]="0"+dateArr[1]}if(dateArr[2]<10){dateArr[2]="0"+dateArr[2]}_self.build=dateArr.join("")}_self.UID=d.getMilliseconds()*MathRound(Math.random()*100);_self.elems.head=doc.getElementsByTagName("head")[0]||doc.body}this.init=function(handler){if(this.initialized===PaintWeb.INIT_DONE){return true}this.initialized=PaintWeb.INIT_STARTED;if(handler&&typeof handler!=="function"){throw new TypeError(lang.initHandlerMustBeFunction)}temp_.onInit=handler;if(!doc.createElement("canvas").getContext){this.initError(lang.noCanvasSupport);return false}if(!window.getComputedStyle){try{if(!win.getComputedStyle(doc.createElement("div"),null)){this.initError(lang.noComputedStyle);return false}}catch(err){this.initError(lang.noComputedStyle);return false}}if(!window.XMLHttpRequest){this.initError(lang.noXMLHttpRequest);return false}if(!this.config.configFile){this.initError(lang.noConfigFile);return false}if(typeof this.config.guiPlaceholder!=="object"||this.config.guiPlaceholder.nodeType!==this.ELEMENT_NODE){this.initError(lang.guiPlaceholderWrong);return false}if(typeof this.config.imageLoad!=="object"||this.config.imageLoad.nodeType!==this.ELEMENT_NODE){this.config.imageLoad=null}if(!window.JSON){this.scriptLoad(PaintWeb.baseFolder+"includes/json2.js",this.jsonlibReady)}else{this.jsonlibReady()}return true};this.jsonlibReady=function(){if(window.pwlib){_self.pwlibReady()}else{_self.scriptLoad(PaintWeb.baseFolder+"includes/lib.js",_self.pwlibReady)}};this.pwlibReady=function(){pwlib=window.pwlib;appEvent=pwlib.appEvent;_self.events=new pwlib.appEvents(_self);_self.configLoad()};this.initError=function(msg){switch(this.initialized){case PaintWeb.INIT_ERROR:case PaintWeb.INIT_DONE:case PaintWeb.INIT_NOT_STARTED:return}this.initialized=PaintWeb.INIT_ERROR;var ev=null;if(this.events&&"dispatch" in this.events&&appEvent&&"appInit" in appEvent){ev=new appEvent.appInit(this.initialized,msg);this.events.dispatch(ev)}if(typeof temp_.onInit==="function"){if(!ev){ev={type:"appInit",state:this.initialized,errorMessage:msg}}temp_.onInit.call(this,ev)}if(this.config.showErrors){alert(msg)}else{if(window.console&&console.log){console.log(msg)}}};this.configLoad=function(){pwlib.xhrLoad(PaintWeb.baseFolder+this.config.configFile,this.configReady)};this.configReady=function(xhr){if(!xhr||xhr.readyState!==4){return}if((xhr.status!==304&&xhr.status!==200)||!xhr.responseText){_self.initError(lang.failedConfigLoad);return}var config=pwlib.jsonParse(xhr.responseText);pwlib.extend(_self.config,config);_self.langLoad()};this.langLoad=function(){var id=this.config.lang,file=PaintWeb.baseFolder;if(!(id in this.config.languages)){id=this.config.lang="en"}if("file" in this.config.languages[id]){file+=this.config.languages[id].file}else{file+=this.config.langFolder+"/"+id+".json"}pwlib.xhrLoad(file,this.langReady)};this.langReady=function(xhr){if(!xhr||xhr.readyState!==4){return}if((xhr.status!==304&&xhr.status!==200)||!xhr.responseText){_self.initError(lang.failedLangLoad);return}pwlib.extend(_self.lang,pwlib.jsonParse(xhr.responseText));if(_self.initCanvas()&&_self.initContext()){_self.guiLoad()}else{_self.initError(lang.errorInitCanvas)}};this.initCommands=function(){if(this.commandRegister("historyUndo",this.historyUndo)&&this.commandRegister("historyRedo",this.historyRedo)&&this.commandRegister("selectAll",this.selectAll)&&this.commandRegister("selectionCut",this.selectionCut)&&this.commandRegister("selectionCopy",this.selectionCopy)&&this.commandRegister("clipboardPaste",this.clipboardPaste)&&this.commandRegister("imageSave",this.imageSave)&&this.commandRegister("imageClear",this.imageClear)&&this.commandRegister("swapFillStroke",this.swapFillStroke)&&this.commandRegister("imageZoomIn",this.imageZoomIn)&&this.commandRegister("imageZoomOut",this.imageZoomOut)&&this.commandRegister("imageZoomReset",this.imageZoomReset)){return true}else{this.initError(lang.errorInitCommands);return false}};this.guiLoad=function(){var cfg=this.config,gui=this.config.gui,base=PaintWeb.baseFolder+cfg.interfacesFolder+"/"+gui+"/",style=base+cfg.guiStyle,script=base+cfg.guiScript;this.styleLoad(gui+"style",style);if(pwlib.gui){this.guiScriptReady()}else{this.scriptLoad(script,this.guiScriptReady)}};this.guiScriptReady=function(){var cfg=_self.config,gui=_self.config.gui,base=cfg.interfacesFolder+"/"+gui+"/",markup=base+cfg.guiMarkup;_self.gui=new pwlib.gui(_self);if(markup in pwlib.fileCache){if(_self.gui.init(pwlib.fileCache[markup])){_self.initTools()}else{_self.initError(lang.errorInitGUI)}}else{pwlib.xhrLoad(PaintWeb.baseFolder+markup,_self.guiMarkupReady)}};this.guiMarkupReady=function(xhr){if(!xhr||xhr.readyState!==4){return}if(xhr.status!==304&&xhr.status!==200){_self.initError(lang.failedMarkupLoad);return}var param;if(xhr.responseXML&&xhr.responseXML.documentElement){param=xhr.responseXML}else{if(xhr.responseText){param=xhr.responseText}else{_self.initError(lang.failedMarkupLoad);return}}if(_self.gui.init(param)){_self.initTools()}else{_self.initError(lang.errorInitGUI)}};this.initCanvas=function(){var cfg=this.config,res=this.resolution,resInfo=doc.getElementById(res.elemId),layerCanvas=doc.createElement("canvas"),bufferCanvas=doc.createElement("canvas"),layerContext=layerCanvas.getContext("2d"),bufferContext=bufferCanvas.getContext("2d"),width=cfg.imageWidth,height=cfg.imageHeight,imageLoad=cfg.imageLoad;if(!resInfo){var style=doc.createElement("style");style.type="text/css";style.appendChild(doc.createTextNode(res.cssText));_self.elems.head.appendChild(style);resInfo=doc.createElement("div");resInfo.id=res.elemId;doc.body.appendChild(resInfo)}if(!resInfo){this.initError(lang.errorInitCanvas);return false}if(!layerCanvas||!bufferCanvas||!layerContext||!bufferContext){this.initError(lang.noCanvasSupport);return false}if(!pwlib.isSameHost(imageLoad.src,win.location.host)){cfg.imageLoad=imageLoad=null;alert(lang.imageLoadDifferentHost)}if(imageLoad){width=parseInt(imageLoad.width);height=parseInt(imageLoad.height)}res.elem=resInfo;this.image.width=layerCanvas.width=bufferCanvas.width=width;this.image.height=layerCanvas.height=bufferCanvas.height=height;this.layer.canvas=layerCanvas;this.layer.context=layerContext;this.buffer.canvas=bufferCanvas;this.buffer.context=bufferContext;if(imageLoad){layerContext.drawImage(imageLoad,0,0)}else{var fillStyle=layerContext.fillStyle;layerContext.fillStyle=cfg.backgroundColor;layerContext.fillRect(0,0,width,height);layerContext.fillStyle=fillStyle}var events=["dblclick","click","mousedown","mouseup","mousemove","contextmenu"],n=events.length;for(var i=0;i<n;i++){bufferCanvas.addEventListener(events[i],this.ev_canvas,false)}return true};this.initContext=function(){var bufferContext=this.buffer.context;if(!pwlib.browser.opera&&bufferContext.shadowColor&&"shadowOffsetX" in bufferContext&&"shadowOffsetY" in bufferContext&&"shadowBlur" in bufferContext){this.shadowSupported=true}else{this.shadowSupported=false}var cfg=this.config,props={fillStyle:cfg.fillStyle,font:cfg.text.fontSize+"px "+cfg.text.fontFamily,lineCap:cfg.line.lineCap,lineJoin:cfg.line.lineJoin,lineWidth:cfg.line.lineWidth,miterLimit:cfg.line.miterLimit,strokeStyle:cfg.strokeStyle,textAlign:cfg.text.textAlign,textBaseline:cfg.text.textBaseline};if(cfg.text.bold){props.font="bold "+props.font}if(cfg.text.italic){props.font="italic "+props.font}if(!bufferContext.fillText&&"mozTextStyle" in bufferContext){props.mozTextStyle=props.font}for(var prop in props){bufferContext[prop]=props[prop]}if(cfg.shadow.enable&&this.shadowSupported){var layerContext=this.layer.context;layerContext.shadowColor=cfg.shadow.shadowColor;layerContext.shadowBlur=cfg.shadow.shadowBlur;layerContext.shadowOffsetX=cfg.shadow.shadowOffsetX;layerContext.shadowOffsetY=cfg.shadow.shadowOffsetY}return true};this.initComplete=function(){if(!this.initCommands()){this.initError(lang.errorInitCommands);return}this.historyAdd();this.image.modified=false;kbListener_=new pwlib.dom.KeyboardEventListener(this.config.guiPlaceholder,{keydown:this.ev_keyboard,keypress:this.ev_keyboard,keyup:this.ev_keyboard});this.updateCanvasScaling();this.win.addEventListener("resize",this.updateCanvasScaling,false);this.events.add("configChange",this.configChangeHandler);this.events.add("imageSaveResult",this.imageSaveResultHandler);if(typeof temp_.onInit==="function"){_self.events.add("appInit",temp_.onInit);delete temp_.onInit}this.initialized=PaintWeb.INIT_DONE;this.events.dispatch(new appEvent.appInit(this.initialized))};this.initTools=function(){var id="",cfg=this.config,n=cfg.tools.length,base=PaintWeb.baseFolder+cfg.toolsFolder+"/";if(n<1){this.initError(lang.noToolConfigured);return}temp_.toolsLoadQueue=n;for(var i=0;i<n;i++){id=cfg.tools[i];if(id in pwlib.tools){this.toolLoaded()}else{this.scriptLoad(base+id+".js",this.toolLoaded)}}};this.toolLoaded=function(){temp_.toolsLoadQueue--;if(temp_.toolsLoadQueue===0){var t=_self.config.tools,n=t.length;for(var i=0;i<n;i++){if(!_self.toolRegister(t[i])){_self.initError(pwlib.strf(lang.toolRegisterFailed,{id:t[i]}));return}}_self.initExtensions()}};this.initExtensions=function(){var id="",cfg=this.config,n=cfg.extensions.length,base=PaintWeb.baseFolder+cfg.extensionsFolder+"/";if(n<1){this.initComplete();return}temp_.extensionsLoadQueue=n;for(var i=0;i<n;i++){id=cfg.extensions[i];if(id in pwlib.extensions){this.extensionLoaded()}else{this.scriptLoad(base+id+".js",this.extensionLoaded)}}};this.extensionLoaded=function(){temp_.extensionsLoadQueue--;if(temp_.extensionsLoadQueue===0){var e=_self.config.extensions,n=e.length;for(var i=0;i<n;i++){if(!_self.extensionRegister(e[i])){_self.initError(pwlib.strf(lang.extensionRegisterFailed,{id:e[i]}));return}}_self.initComplete()}};this.updateCanvasScaling=function(){var res=_self.resolution,cs=win.getComputedStyle(res.elem,null),image=_self.image;bufferStyle=_self.buffer.canvas.style,layerStyle=_self.layer.canvas.style,scaleNew=1,width=parseInt(cs.width),height=parseInt(cs.height);if(pwlib.browser.opera){scaleNew=win.innerHeight/height;scaleNew=MathRound(scaleNew*10)/10}else{if(width&&!isNaN(width)&&width!==res.dpiOptimal){res.dpiLocal=width;scaleNew=MathFloor(res.dpiLocal/res.dpiOptimal)}else{if(pwlib.browser.olpcxo&&pwlib.browser.gecko){res.dpiLocal=134;var appUnitsPerCSSPixel=60,devPixelsPerCSSPixel=res.dpiLocal/res.dpiOptimal;appUnitsPerDevPixel=appUnitsPerCSSPixel/devPixelsPerCSSPixel;scaleNew=appUnitsPerCSSPixel/MathFloor(appUnitsPerDevPixel);if("mozImageSmoothingEnabled" in layerStyle){layerStyle.mozImageSmoothingEnabled=bufferStyle.mozImageSmoothingEnabled=false}}}}if(scaleNew===res.scale){return}res.scale=scaleNew;var styleWidth=image.width/res.scale*image.zoom,styleHeight=image.height/res.scale*image.zoom;image.canvasScale=styleWidth/image.width;bufferStyle.width=layerStyle.width=styleWidth+"px";bufferStyle.height=layerStyle.height=styleHeight+"px";_self.events.dispatch(new appEvent.canvasSizeChange(styleWidth,styleHeight,image.canvasScale))};this.ev_canvas=function(ev){if(!_self.tool){return false}switch(ev.type){case"mousedown":if(_self.mouse.buttonDown){return false}_self.mouse.buttonDown=true;break;case"mouseup":if(!_self.mouse.buttonDown){return false}_self.mouse.buttonDown=false}if("layerX" in ev){if(_self.image.canvasScale===1){_self.mouse.x=ev.layerX;_self.mouse.y=ev.layerY}else{_self.mouse.x=MathRound(ev.layerX/_self.image.canvasScale);_self.mouse.y=MathRound(ev.layerY/_self.image.canvasScale)}}else{if("offsetX" in ev){if(_self.image.canvasScale===1){_self.mouse.x=ev.offsetX;_self.mouse.y=ev.offsetY}else{_self.mouse.x=MathRound(ev.offsetX/_self.image.canvasScale);_self.mouse.y=MathRound(ev.offsetY/_self.image.canvasScale)}}}if(ev.type in _self.tool&&_self.tool[ev.type](ev)){ev.preventDefault();return true}else{return false}};this.ev_keyboard=function(ev){if(!ev.key_){return}if(ev.target&&ev.target.nodeName){switch(ev.target.nodeName.toLowerCase()){case"input":if(ev.type==="keypress"&&(ev.key_==="Up"||ev.key_==="Down")&&ev.target.getAttribute("type")==="number"){_self.ev_numberInput(ev)}case"select":case"textarea":case"button":return}}if(ev.type==="keypress"&&ev.char_){var isZoomKey=true,imageZoomKeys=_self.config.imageZoomKeys;switch(ev.char_){case imageZoomKeys["in"]:_self.imageZoomIn(ev);break;case imageZoomKeys.out:_self.imageZoomOut(ev);break;case imageZoomKeys.reset:_self.imageZoomReset(ev);break;default:isZoomKey=false}if(isZoomKey){ev.preventDefault();return}}ev.kid_="";var i,kmods={altKey:"Alt",ctrlKey:"Control",shiftKey:"Shift"};for(i in kmods){if(ev[i]&&ev.key_!==kmods[i]){ev.kid_+=kmods[i]+" "}}ev.kid_+=ev.key_;if(_self.tool&&ev.type in _self.tool&&_self.tool[ev.type](ev)){return true}var gkey=_self.config.keys[ev.kid_];if(!gkey){return false}ev.kobj_=gkey;if("extension" in gkey){var extension=_self.extensions[gkey.extension],method=gkey.method||ev.type;if(method in extension){extension[method].call(this,ev)}}else{if("command" in gkey&&gkey.command in _self.commands){_self.commands[gkey.command].call(this,ev)}else{if(ev.type==="keydown"&&"toolActivate" in gkey){_self.toolActivate(gkey.toolActivate,ev)}}}if(ev.type==="keypress"){ev.preventDefault()}};this.ev_numberInput=function(ev){var target=ev.target;var val,max=parseFloat(target.getAttribute("max")),min=parseFloat(target.getAttribute("min")),step=parseFloat(target.getAttribute("step"));if(target.value===""||target.value===null){val=!isNaN(min)?min:0}else{val=parseFloat(target.value.replace(/[,.]+/g,".").replace(/[^0-9.\-]/g,""))}if(isNaN(val)){val=min||0}if(isNaN(step)){step=1}if(ev.shiftKey){step*=2}if(ev.key_==="Down"){step*=-1}val+=step;if(!isNaN(max)&&val>max){val=max}else{if(!isNaN(min)&&val<min){val=min}}if(val==target.value){return}target.value=val;if(doc.createEvent&&target.dispatchEvent){var ev_change=doc.createEvent("HTMLEvents");ev_change.initEvent("change",true,true);target.dispatchEvent(ev_change)}};this.imageZoomIn=function(ev){if(ev&&ev.shiftKey){_self.config.imageZoomStep*=2}var res=_self.imageZoomTo("+");if(ev&&ev.shiftKey){_self.config.imageZoomStep/=2}return res};this.imageZoomOut=function(ev){if(ev&&ev.shiftKey){_self.config.imageZoomStep*=2}var res=_self.imageZoomTo("-");if(ev&&ev.shiftKey){_self.config.imageZoomStep/=2}return res};this.imageZoomReset=function(ev){return _self.imageZoomTo(1)};this.imageZoomTo=function(level){var image=this.image,config=this.config,res=this.resolution;if(!level){return false}else{if(level==="+"){level=image.zoom+config.imageZoomStep}else{if(level==="-"){level=image.zoom-config.imageZoomStep}else{if(typeof level!=="number"){return false}}}}if(level>config.imageZoomMax){level=config.imageZoomMax}else{if(level<config.imageZoomMin){level=config.imageZoomMin}}if(level===image.zoom){return true}var cancel=this.events.dispatch(new appEvent.imageZoom(level));if(cancel){return false}var styleWidth=image.width/res.scale*level,styleHeight=image.height/res.scale*level,bufferStyle=this.buffer.canvas.style,layerStyle=this.layer.canvas.style;image.canvasScale=styleWidth/image.width;bufferStyle.width=layerStyle.width=styleWidth+"px";bufferStyle.height=layerStyle.height=styleHeight+"px";image.zoom=level;this.events.dispatch(new appEvent.canvasSizeChange(styleWidth,styleHeight,image.canvasScale));return true};this.imageCrop=function(cropX,cropY,cropWidth,cropHeight){var bufferCanvas=this.buffer.canvas,bufferContext=this.buffer.context,image=this.image,layerCanvas=this.layer.canvas,layerContext=this.layer.context;cropX=parseInt(cropX);cropY=parseInt(cropY);cropWidth=parseInt(cropWidth);cropHeight=parseInt(cropHeight);if(!cropWidth||!cropHeight||isNaN(cropX)||isNaN(cropY)||isNaN(cropWidth)||isNaN(cropHeight)||cropX>=image.width||cropY>=image.height){return false}var cancel=this.events.dispatch(new appEvent.imageCrop(cropX,cropY,cropWidth,cropHeight));if(cancel){return false}if(cropWidth>this.config.imageWidthMax){cropWidth=this.config.imageWidthMax}if(cropHeight>this.config.imageHeightMax){cropHeight=this.config.imageHeightMax}if(cropX===0&&cropY===0&&image.width===cropWidth&&image.height===cropHeight){return true}var layerData=null,bufferData=null,layerState=this.stateSave(layerContext),bufferState=this.stateSave(bufferContext),scaledWidth=cropWidth*image.canvasScale,scaledHeight=cropHeight*image.canvasScale,dataWidth=MathMin(image.width,cropWidth),dataHeight=MathMin(image.height,cropHeight),sumX=cropX+dataWidth,sumY=cropY+dataHeight;if(sumX>image.width){dataWidth-=sumX-image.width}if(sumY>image.height){dataHeight-=sumY-image.height}if(layerContext.getImageData){try{layerData=layerContext.getImageData(cropX,cropY,dataWidth,dataHeight)}catch(err){}}if(bufferContext.getImageData){try{bufferData=bufferContext.getImageData(cropX,cropY,dataWidth,dataHeight)}catch(err){}}bufferCanvas.style.width=layerCanvas.style.width=scaledWidth+"px";bufferCanvas.style.height=layerCanvas.style.height=scaledHeight+"px";layerCanvas.width=cropWidth;layerCanvas.height=cropHeight;if(layerData&&layerContext.putImageData){layerContext.putImageData(layerData,0,0)}this.stateRestore(layerContext,layerState);state=this.stateSave(bufferContext);bufferCanvas.width=cropWidth;bufferCanvas.height=cropHeight;if(bufferData&&bufferContext.putImageData){bufferContext.putImageData(bufferData,0,0)}this.stateRestore(bufferContext,bufferState);image.width=cropWidth;image.height=cropHeight;bufferState=layerState=layerData=bufferData=null;this.events.dispatch(new appEvent.imageSizeChange(cropWidth,cropHeight));this.events.dispatch(new appEvent.canvasSizeChange(scaledWidth,scaledHeight,image.canvasScale));return true};this.stateSave=function(context){if(!context||!context.canvas||!this.stateProperties){return false}var stateObj={},prop=null,n=this.stateProperties.length;for(var i=0;i<n;i++){prop=this.stateProperties[i];stateObj[prop]=context[prop]}return stateObj};this.stateRestore=function(context,stateObj){if(!context||!context.canvas){return false}for(var state in stateObj){context[state]=stateObj[state]}return true};this.shadowAllow=function(){if(this.shadowAllowed||!this.shadowSupported){return}var context=this.layer.context,cfg=this.config.shadow;if(cfg.enable){context.shadowColor=cfg.shadowColor;context.shadowOffsetX=cfg.shadowOffsetX;context.shadowOffsetY=cfg.shadowOffsetY;context.shadowBlur=cfg.shadowBlur}this.shadowAllowed=true;this.events.dispatch(new appEvent.shadowAllow(true))};this.shadowDisallow=function(){if(!this.shadowAllowed||!this.shadowSupported){return}if(this.config.shadow.enable){var context=this.layer.context;context.shadowColor="rgba(0,0,0,0)";context.shadowOffsetX=0;context.shadowOffsetY=0;context.shadowBlur=0}this.shadowAllowed=false;this.events.dispatch(new appEvent.shadowAllow(false))};this.layerUpdate=function(){this.layer.context.drawImage(this.buffer.canvas,0,0);this.buffer.context.clearRect(0,0,this.image.width,this.image.height);this.historyAdd();return true};this.historyAdd=function(){var layerContext=this.layer.context,history=this.history,prevPos=history.pos;if(!layerContext.getImageData){return false}if(prevPos<history.states.length){history.states.splice(prevPos,history.states.length)}try{history.states.push(layerContext.getImageData(0,0,this.image.width,this.image.height))}catch(err){return false}if("historyLimit" in this.config&&history.states.length>this.config.historyLimit){history.states.splice(0,history.states.length-this.config.historyLimit)}history.pos=history.states.length;this.image.modified=true;this.events.dispatch(new appEvent.historyUpdate(history.pos,prevPos,history.pos));return true};this.historyGoto=function(pos){var layerContext=this.layer.context,image=this.image,history=this.history;if(!history.states.length||!layerContext.putImageData){return false}var cpos=history.pos;if(pos==="undo"){pos=cpos-1}else{if(pos==="redo"){pos=cpos+1}}if(pos<1||pos>history.states.length){return false}var himg=history.states[pos-1];if(!himg){return false}var w=MathMin(image.width,himg.width),h=MathMin(image.height,himg.height);layerContext.clearRect(0,0,image.width,image.height);try{layerContext.putImageData(himg,0,0,0,0,w,h)}catch(err){var tmp=doc.createElement("canvas");tmp.width=himg.width;tmp.height=himg.height;var tmp2=tmp.getContext("2d");tmp2.putImageData(himg,0,0);layerContext.drawImage(tmp,0,0);tmp2=tmp=null;delete tmp2,tmp}history.pos=pos;this.events.dispatch(new appEvent.historyUpdate(pos,cpos,history.states.length));return true};this.historyReset=function(){this.history.pos=0;this.history.states=[];this.events.dispatch(new appEvent.historyUpdate(0,0,0))};this.toolSnapXY=function(x,y){var diffx=MathAbs(_self.mouse.x-x),diffy=MathAbs(_self.mouse.y-y);if(diffx>diffy){_self.mouse.y=y}else{_self.mouse.x=x}};this.toolActivate=function(id,ev){if(!id||!(id in pwlib.tools)||typeof pwlib.tools[id]!=="function"){return false}var tool=pwlib.tools[id],prevId=this.tool?this.tool._id:null;if(prevId&&this.tool instanceof pwlib.tools[id]){return true}var cancel=this.events.dispatch(new appEvent.toolPreactivate(id,prevId));if(cancel){return false}var tool_obj=new tool(this,ev);if(!tool_obj){return false}if("preActivate" in tool_obj&&!tool_obj.preActivate(ev)){tool_obj=null;return false}if(this.tool&&"deactivate" in this.tool){this.tool.deactivate(ev)}this.tool=tool_obj;this.mouse.buttonDown=false;if("activate" in this.tool){this.tool.activate(ev)}this.events.dispatch(new appEvent.toolActivate(id,prevId));return true};this.toolRegister=function(id){if(typeof id!=="string"||!id){return false}var tool=pwlib.tools[id];if(typeof tool!=="function"){return false}tool.prototype._id=id;this.events.dispatch(new appEvent.toolRegister(id));if(!this.tool&&id===this.config.toolDefault){return this.toolActivate(id)}else{return true}};this.toolUnregister=function(id){if(typeof id!=="string"||!id||!(id in pwlib.tools)){return false}this.events.dispatch(new appEvent.toolUnregister(id));return true};this.extensionRegister=function(id){if(typeof id!=="string"||!id){return false}var func=pwlib.extensions[id];if(typeof func!=="function"){return false}func.prototype._id=id;var obj=new func(_self);if("extensionRegister" in obj&&!obj.extensionRegister()){return false}this.extensions[id]=obj;this.events.dispatch(new appEvent.extensionRegister(id));return true};this.extensionUnregister=function(id){if(typeof id!=="string"||!id||!(id in this.extensions)){return false}this.events.dispatch(new appEvent.extensionUnregister(id));if("extensionUnregister" in this.extensions[id]){this.extensions[id].extensionUnregister()}delete this.extensions[id];return true};this.commandRegister=function(id,func){if(typeof id!=="string"||!id||typeof func!=="function"||id in this.commands){return false}this.commands[id]=func;this.events.dispatch(new appEvent.commandRegister(id));return true};this.commandUnregister=function(id){if(typeof id!=="string"||!id||!(id in this.commands)){return false}this.events.dispatch(new appEvent.commandUnregister(id));delete this.commands[id];return true};this.scriptLoad=function(url,handler){if(!handler){var elem=doc.createElement("script");elem.type="text/javascript";elem.src=url;this.elems.head.appendChild(elem);return}var xhr=new XMLHttpRequest();xhr.onreadystatechange=function(){if(!xhr||xhr.readyState!==4){return}else{if((xhr.status!==304&&xhr.status!==200)||!xhr.responseText){handler(false,xhr)}else{try{eval.call(win,xhr.responseText)}catch(err){eval(xhr.responseText,win)}handler(true,xhr)}}xhr=null};xhr.open("GET",url);xhr.send("")};this.styleLoad=function(id,url,media,handler){id="paintweb_style_"+id;var elem=doc.getElementById(id);if(elem){return}if(!media){media="screen, projection"}elem=doc.createElement("link");if(handler){elem.addEventListener("load",handler,false)}elem.id=id;elem.rel="stylesheet";elem.type="text/css";elem.media=media;elem.href=url;this.elems.head.appendChild(elem)};this.historyUndo=function(){return _self.historyGoto("undo")};this.historyRedo=function(){return _self.historyGoto("redo")};this.imageLoad=function(importImage){if(!importImage||!importImage.width||!importImage.height||importImage.nodeType!==this.ELEMENT_NODE||!pwlib.isSameHost(importImage.src,win.location.host)){return false}this.historyReset();var layerContext=this.layer.context,layerCanvas=this.layer.canvas,layerStyle=layerCanvas.style,bufferCanvas=this.buffer.canvas,bufferStyle=bufferCanvas.style,image=this.image,styleWidth=importImage.width*image.canvasScale,styleHeight=importImage.height*image.canvasScale,result=true;bufferCanvas.width=layerCanvas.width=importImage.width;bufferCanvas.height=layerCanvas.height=importImage.height;bufferStyle.width=layerStyle.width=styleWidth+"px";bufferStyle.height=layerStyle.height=styleHeight+"px";try{layerContext.drawImage(importImage,0,0)}catch(err){result=false;bufferCanvas.width=layerCanvas.width=image.width;bufferCanvas.height=layerCanvas.height=image.height;styleWidth=image.width*image.canvasScale;styleHeight=image.height*image.canvasScale;bufferStyle.width=layerStyle.width=styleWidth+"px";bufferStyle.height=layerStyle.height=styleHeight+"px"}if(result){image.width=importImage.width;image.height=importImage.height;_self.config.imageLoad=importImage;this.events.dispatch(new appEvent.imageSizeChange(image.width,image.height));this.events.dispatch(new appEvent.canvasSizeChange(styleWidth,styleHeight,image.canvasScale))}this.historyAdd();image.modified=false;return result};this.imageClear=function(ev){var layerContext=_self.layer.context,image=_self.image;layerContext.clearRect(0,0,image.width,image.height);var fillStyle=layerContext.fillStyle;layerContext.fillStyle=_self.config.backgroundColor;layerContext.fillRect(0,0,image.width,image.height);layerContext.fillStyle=fillStyle;_self.historyAdd()};this.imageSave=function(type){var canvas=_self.layer.canvas,cfg=_self.config,img=_self.image,imageLoad=_self.config.imageLoad,ext="png",idata=null,src=null,pos;if(!canvas.toDataURL){return false}var extMap={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif"};if(typeof type!=="string"||!type){if(imageLoad&&imageLoad.src&&imageLoad.src.substr(0,5)!=="data:"){src=imageLoad.src;pos=src.indexOf("?");if(pos!==-1){src=src.substr(0,pos)}ext=src.substr(src.lastIndexOf(".")+1).toLowerCase()}type=extMap[ext]||"image/png"}if(type!=="image/png"){canvas=doc.createElement("canvas");var context=canvas.getContext("2d");canvas.width=img.width;canvas.height=img.height;context.fillStyle=cfg.backgroundColor;context.fillRect(0,0,img.width,img.height);context.drawImage(_self.layer.canvas,0,0);context=null}try{if(type==="image/jpeg"&&!pwlib.browser.gecko){idata=canvas.toDataURL(type,cfg.jpegSaveQuality)}else{idata=canvas.toDataURL(type)}}catch(err){alert(lang.errorImageSave+"\n"+err);return false}canvas=null;if(!idata||idata==="data:,"){return false}var ev=new appEvent.imageSave(idata,img.width,img.height),cancel=_self.events.dispatch(ev);if(cancel){return true}$("#img-list-search").addClass("ajax-loading-items");$("#img-list-search").html("");$.postJSON(_self.config.uploadCanvasURL,{img:idata},function(data){$("#img-list-search").html(data.result);$("#img-list-search").removeClass("ajax-loading-items");return true});idata=null;_self.events.dispatch(new appEvent.imageSaveResult(true));return false};this.imageSaveResultHandler=function(ev){if(ev.successful){_self.image.modified=false}};this.swapFillStroke=function(){var fillStyle=_self.config.fillStyle,strokeStyle=_self.config.strokeStyle;_self.config.fillStyle=strokeStyle;_self.config.strokeStyle=fillStyle;var ev=new appEvent.configChange(strokeStyle,fillStyle,"fillStyle","",_self.config);_self.events.dispatch(ev);ev=new appEvent.configChange(fillStyle,strokeStyle,"strokeStyle","",_self.config);_self.events.dispatch(ev)};this.selectAll=function(ev){if(_self.toolActivate("selection",ev)){return _self.tool.selectAll(ev)}else{return false}};this.selectionCut=function(ev){if(!_self.tool||_self.tool._id!=="selection"){return false}else{return _self.tool.selectionCut(ev)}};this.selectionCopy=function(ev){if(!_self.tool||_self.tool._id!=="selection"){return false}else{return _self.tool.selectionCopy(ev)}};this.clipboardPaste=function(ev){if(!_self.clipboard||!_self.toolActivate("selection",ev)){return false}else{return _self.tool.clipboardPaste(ev)}};this.configChangeHandler=function(ev){if(ev.group==="shadow"&&_self.shadowSupported&&_self.shadowAllowed){var context=_self.layer.context,cfg=ev.groupRef;if(ev.config==="enable"){if(ev.value){context.shadowColor=cfg.shadowColor;context.shadowOffsetX=cfg.shadowOffsetX;context.shadowOffsetY=cfg.shadowOffsetY;context.shadowBlur=cfg.shadowBlur}else{context.shadowColor="rgba(0,0,0,0)";context.shadowOffsetX=0;context.shadowOffsetY=0;context.shadowBlur=0}return}if(!cfg.enable){return}switch(ev.config){case"shadowBlur":case"shadowOffsetX":case"shadowOffsetY":ev.value=parseInt(ev.value);case"shadowColor":context[ev.config]=ev.value}}else{if(ev.group==="line"){switch(ev.config){case"lineWidth":case"miterLimit":ev.value=parseInt(ev.value);case"lineJoin":case"lineCap":_self.buffer.context[ev.config]=ev.value}}else{if(ev.group==="text"){switch(ev.config){case"textAlign":case"textBaseline":_self.buffer.context[ev.config]=ev.value}}else{if(!ev.group){switch(ev.config){case"fillStyle":case"strokeStyle":_self.buffer.context[ev.config]=ev.value}}}}}};this.destroy=function(){this.events.dispatch(new appEvent.appDestroy());for(var cmd in this.commands){this.commandUnregister(cmd)}for(var ext in this.extensions){this.extensionUnregister(ext)}for(var tool in this.gui.tools){this.toolUnregister(tool)}this.gui.destroy();this.initialized=PaintWeb.INIT_NOT_STARTED};this.toString=function(){return"PaintWeb v"+this.version+" (build "+this.build+")"};preInit()}PaintWeb.INIT_NOT_STARTED=0;PaintWeb.INIT_STARTED=1;PaintWeb.INIT_DONE=2;PaintWeb.INIT_ERROR=-1;PaintWeb.baseFolder="";(function(){var a=document.getElementsByTagName("script"),e=a.length,d,c;for(var b=0;b<e;b++){c=a[b].src;if(!c||!/paintweb(\.dev|\.src)?\.js/.test(c)){continue}d=c.lastIndexOf("/");if(d!==-1){PaintWeb.baseFolder=c.substr(0,d+1)}break}})();